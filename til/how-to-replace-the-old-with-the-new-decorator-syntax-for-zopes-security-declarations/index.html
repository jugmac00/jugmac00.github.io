<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>How to Replace the Old With the New Decorator Syntax for Zope's Security Declarations | Jürgen Gmach</title><meta name=keywords content="zope,vscode"><meta name=description content="Zope&rsquo;s security architecture is built upon security declarations, which scope can be either a method, several methods or even a complete class.
Until recently you usually declared the security for a method like this&mldr;
from AccessControl import getSecurityManager class Suggestions(SomeBaseClass): security = ClassSecurityInfo() security.declareProtected(&#34;View&#34;, &#34;all_suggestions&#34;) def all_suggestions(): ... Then, when accessing this method, e.g. the logged in user&rsquo;s role or group was checked against the security declaration.
One big disadvantage was that you could easily introduce typos."><meta name=author content><link rel=canonical href=https://jugmac00.github.io/til/how-to-replace-the-old-with-the-new-decorator-syntax-for-zopes-security-declarations/><link crossorigin=anonymous href=/assets/css/stylesheet.96771a12b249af1ff464eabdaa85d1a5268a4379a9f2da62cfd409656ff0233b.css integrity="sha256-lncaErJJrx/0ZOq9qoXRpSaKQ3mp8tpiz9QJZW/wIzs=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script><link rel=icon href=https://jugmac00.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://jugmac00.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://jugmac00.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://jugmac00.github.io/apple-touch-icon.png><link rel=mask-icon href=https://jugmac00.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="How to Replace the Old With the New Decorator Syntax for Zope's Security Declarations"><meta property="og:description" content="Zope&rsquo;s security architecture is built upon security declarations, which scope can be either a method, several methods or even a complete class.
Until recently you usually declared the security for a method like this&mldr;
from AccessControl import getSecurityManager class Suggestions(SomeBaseClass): security = ClassSecurityInfo() security.declareProtected(&#34;View&#34;, &#34;all_suggestions&#34;) def all_suggestions(): ... Then, when accessing this method, e.g. the logged in user&rsquo;s role or group was checked against the security declaration.
One big disadvantage was that you could easily introduce typos."><meta property="og:type" content="article"><meta property="og:url" content="https://jugmac00.github.io/til/how-to-replace-the-old-with-the-new-decorator-syntax-for-zopes-security-declarations/"><meta property="article:section" content="til"><meta property="article:published_time" content="2020-04-11T13:52:33+02:00"><meta property="article:modified_time" content="2020-04-11T13:52:33+02:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="How to Replace the Old With the New Decorator Syntax for Zope's Security Declarations"><meta name=twitter:description content="Zope&rsquo;s security architecture is built upon security declarations, which scope can be either a method, several methods or even a complete class.
Until recently you usually declared the security for a method like this&mldr;
from AccessControl import getSecurityManager class Suggestions(SomeBaseClass): security = ClassSecurityInfo() security.declareProtected(&#34;View&#34;, &#34;all_suggestions&#34;) def all_suggestions(): ... Then, when accessing this method, e.g. the logged in user&rsquo;s role or group was checked against the security declaration.
One big disadvantage was that you could easily introduce typos."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Today I Learned","item":"https://jugmac00.github.io/til/"},{"@type":"ListItem","position":3,"name":"How to Replace the Old With the New Decorator Syntax for Zope's Security Declarations","item":"https://jugmac00.github.io/til/how-to-replace-the-old-with-the-new-decorator-syntax-for-zopes-security-declarations/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"How to Replace the Old With the New Decorator Syntax for Zope's Security Declarations","name":"How to Replace the Old With the New Decorator Syntax for Zope\u0027s Security Declarations","description":"Zope\u0026rsquo;s security architecture is built upon security declarations, which scope can be either a method, several methods or even a complete class.\nUntil recently you usually declared the security for a method like this\u0026hellip;\nfrom AccessControl import getSecurityManager class Suggestions(SomeBaseClass): security = ClassSecurityInfo() security.declareProtected(\u0026#34;View\u0026#34;, \u0026#34;all_suggestions\u0026#34;) def all_suggestions(): ... Then, when accessing this method, e.g. the logged in user\u0026rsquo;s role or group was checked against the security declaration.\nOne big disadvantage was that you could easily introduce typos.","keywords":["zope","vscode"],"articleBody":"Zope’s security architecture is built upon security declarations, which scope can be either a method, several methods or even a complete class.\nUntil recently you usually declared the security for a method like this…\nfrom AccessControl import getSecurityManager class Suggestions(SomeBaseClass): security = ClassSecurityInfo() security.declareProtected(\"View\", \"all_suggestions\") def all_suggestions(): ... Then, when accessing this method, e.g. the logged in user’s role or group was checked against the security declaration.\nOne big disadvantage was that you could easily introduce typos. e.g. when you wrote security.declareProtected(\"View\", \"all_sugestions\"), the method was no longer protected again.\nA couple of years ago, a new decorator syntax was introduced for security declarations.\nCompare the old vs the new syntax - much nicer and less error prone…\nsecurity.declarePublic # versus @security.public security.declareProtected(\"View\", \"method\") # versus @security.protected(\"View\") def ... security.declarePrivate(\"method\") # versus @security.private def ... Ok, very nice. But what do you do when you have hundreds or thousands of declarations?\nsearch/replace over many files While most IDEs have a comfortable search/replace function, I will use VS Code to show what to do.\nFor all operations do the following…\n in the top right corner, click on Edit and then on Replace in Files (As keyboard shortcuts are very individual and also differ from OS to OS, I will not mention them here.) activate the regex mode by clicking on the third icon besides the Search field  replace security.declarePublic Actually, I only had like 10 declarations of this kind, so I reviewed and replaced them manually, but the following search/replace should do it.\n# Search security.declarePublic # Replace @security.public replace security.declarePrivate(“method_name”) This one is also trivial. The regex matches both single and double quotes, and also the method name, but the latter one can be dropped.\n# Search security.declarePrivate\\(['\"].*\\)$ # Replace @security.private Attention As I had several methods marked with the @staticmethod decorator, test collection failed after this search/replace operation, as the order of decorators is important!\nSo I did another search/replace to fix the order…\n# Search @security.private @staticmethod # Replace @staticmethod @security.private replace security.declareProtected(“permission_name”, “method_name”) This one is a bit more evolved, as the permission name must be retained.\nIn order to make this work, you need to capture the permission name, which can be achieved by using a group: `(.*).\nYou then can access the value of the group via the placeholder $1.\n# Search security.declareProtected\\('(.*)', '.*'\\)$ # Replace @security.protected(\"$1\") Attention Again, the test runner showed some problems because of a wrong order of decorators.\nconclusion Updating my code base, consisting of hundreds of files and thousands security declarations only took a couple of minutes, thanks to VS Code and a good test suite.\n","wordCount":"436","inLanguage":"en","datePublished":"2020-04-11T13:52:33+02:00","dateModified":"2020-04-11T13:52:33+02:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://jugmac00.github.io/til/how-to-replace-the-old-with-the-new-decorator-syntax-for-zopes-security-declarations/"},"publisher":{"@type":"Organization","name":"Jürgen Gmach","logo":{"@type":"ImageObject","url":"https://jugmac00.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add('dark'):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove('dark'):window.matchMedia('(prefers-color-scheme: dark)').matches&&document.body.classList.add('dark')</script><header class=header><nav class=nav><div class=logo><a href=https://jugmac00.github.io accesskey=h title="Jürgen Gmach (Alt + H)">Jürgen Gmach</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://jugmac00.github.io/about/ title=about><span>about</span></a></li><li><a href=https://jugmac00.github.io/blog/ title=blog><span>blog</span></a></li><li><a href=https://jugmac00.github.io/til/ title=til><span>today-i-learned</span></a></li><li><a href=https://jugmac00.github.io/talks/ title=talks><span>talks</span></a></li><li><a href=https://jugmac00.github.io/hiring/ title=hiring><span>hiring</span></a></li><li><a href=https://jugmac00.github.io/tags/ title=tags><span>tags</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>How to Replace the Old With the New Decorator Syntax for Zope's Security Declarations</h1><div class=post-meta><span title="2020-04-11 13:52:33 +0200 +0200">April 11, 2020</span></div></header><div class=post-content><p><a href=https://github.com/zopefoundation/Zope>Zope&rsquo;s</a> security architecture is built upon security declarations,
which scope can be either a method, several methods or even a complete class.</p><p>Until <em>recently</em> you usually declared the security for a method like this&mldr;</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#f92672>from</span> AccessControl <span style=color:#f92672>import</span> getSecurityManager

<span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Suggestions</span>(SomeBaseClass):
    security <span style=color:#f92672>=</span> ClassSecurityInfo()
    
    security<span style=color:#f92672>.</span>declareProtected(<span style=color:#e6db74>&#34;View&#34;</span>, <span style=color:#e6db74>&#34;all_suggestions&#34;</span>)
    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>all_suggestions</span>():
        <span style=color:#f92672>...</span>
</code></pre></div><p>Then, when accessing this method,
e.g. the logged in user&rsquo;s role or group was checked against the security declaration.</p><p>One big disadvantage was that you could easily introduce typos.
e.g. when you wrote <code>security.declareProtected("View", "all_sugestions")</code>,
the method was no longer protected again.</p><p>A couple of years ago,
a new decorator syntax was introduced for security declarations.</p><p>Compare the old vs the new syntax - much nicer and less error prone&mldr;</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python>security<span style=color:#f92672>.</span>declarePublic
<span style=color:#75715e># versus</span>
<span style=color:#a6e22e>@security.public</span>
</code></pre></div><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python>security<span style=color:#f92672>.</span>declareProtected(<span style=color:#e6db74>&#34;View&#34;</span>, <span style=color:#e6db74>&#34;method&#34;</span>)
<span style=color:#75715e># versus</span>
<span style=color:#a6e22e>@security.protected</span>(<span style=color:#e6db74>&#34;View&#34;</span>)
<span style=color:#66d9ef>def</span> <span style=color:#f92672>...</span>
</code></pre></div><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python>security<span style=color:#f92672>.</span>declarePrivate(<span style=color:#e6db74>&#34;method&#34;</span>)
<span style=color:#75715e># versus</span>
<span style=color:#a6e22e>@security.private</span>
<span style=color:#66d9ef>def</span> <span style=color:#f92672>...</span>
</code></pre></div><p>Ok, very nice. But what do you do when you have hundreds or thousands of declarations?</p><h2 id=searchreplace-over-many-files>search/replace over many files<a hidden class=anchor aria-hidden=true href=#searchreplace-over-many-files>#</a></h2><p>While most IDEs have a comfortable search/replace function,
I will use <strong>VS Code</strong> to show what to do.</p><p>For all operations do the following&mldr;</p><ul><li>in the top right corner, click on <strong>Edit</strong> and then on <strong>Replace in Files</strong> (As keyboard shortcuts are very individual and also differ from OS to OS, I will not mention them here.)</li><li>activate the regex mode by clicking on the third icon besides the <strong>Search</strong> field</li></ul><h3 id=replace-securitydeclarepublic>replace security.declarePublic<a hidden class=anchor aria-hidden=true href=#replace-securitydeclarepublic>#</a></h3><p>Actually, I only had like 10 declarations of this kind,
so I reviewed and replaced them manually,
but the following search/replace should do it.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#75715e># Search</span>
security<span style=color:#f92672>.</span>declarePublic

<span style=color:#75715e># Replace</span>
<span style=color:#a6e22e>@security.public</span>
</code></pre></div><h3 id=replace-securitydeclareprivatemethod_name>replace security.declarePrivate(&ldquo;method_name&rdquo;)<a hidden class=anchor aria-hidden=true href=#replace-securitydeclareprivatemethod_name>#</a></h3><p>This one is also trivial.
The regex matches both single and double quotes,
and also the method name, but the latter one can be dropped.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#75715e># Search</span>
security<span style=color:#f92672>.</span>declarePrivate\([<span style=color:#e6db74>&#39;&#34;].*\)$</span>

<span style=color:#75715e># Replace</span>
<span style=color:#a6e22e>@security.private</span>
</code></pre></div><p><strong>Attention</strong> As I had several methods marked with the <code>@staticmethod</code> decorator,
test collection failed after this search/replace operation,
as the order of decorators is important!</p><p>So I did another search/replace to fix the order&mldr;</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#75715e># Search</span>
    <span style=color:#a6e22e>@security.private</span>
    <span style=color:#a6e22e>@staticmethod</span>

<span style=color:#75715e># Replace</span>
    <span style=color:#a6e22e>@staticmethod</span>
    <span style=color:#a6e22e>@security.private</span>
</code></pre></div><h3 id=replace-securitydeclareprotectedpermission_name-method_name>replace security.declareProtected(&ldquo;permission_name&rdquo;, &ldquo;method_name&rdquo;)<a hidden class=anchor aria-hidden=true href=#replace-securitydeclareprotectedpermission_name-method_name>#</a></h3><p>This one is a bit more evolved,
as the permission name must be retained.</p><p>In order to make this work,
you need to capture the permission name,
which can be achieved by using a group: `(.*).</p><p>You then can access the value of the group via the placeholder <code>$1</code>.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#75715e># Search</span>
security<span style=color:#f92672>.</span>declareProtected\(<span style=color:#e6db74>&#39;(.*)&#39;</span>, <span style=color:#e6db74>&#39;.*&#39;</span>\)<span style=color:#960050;background-color:#1e0010>$</span>

<span style=color:#75715e># Replace</span>
<span style=color:#a6e22e>@security.protected</span>(<span style=color:#e6db74>&#34;$1&#34;</span>)
</code></pre></div><p><strong>Attention</strong> Again, the test runner showed some problems because of a wrong order of decorators.</p><h2 id=conclusion>conclusion<a hidden class=anchor aria-hidden=true href=#conclusion>#</a></h2><p>Updating my code base,
consisting of hundreds of files and thousands security declarations only took a couple of minutes,
thanks to <strong>VS Code</strong> and a good test suite.</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://jugmac00.github.io/tags/zope/>zope</a></li><li><a href=https://jugmac00.github.io/tags/vscode/>vscode</a></li></ul></footer></article></main><footer class=footer><span>&copy; 2022 <a href=https://jugmac00.github.io>Jürgen Gmach</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById('menu');menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(a=>{a.addEventListener("click",function(b){b.preventDefault();var a=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView({behavior:"smooth"}),a==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${a}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove('dark'),localStorage.setItem("pref-theme",'light')):(document.body.classList.add('dark'),localStorage.setItem("pref-theme",'dark'))})</script></body></html>