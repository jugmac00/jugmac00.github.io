<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>How to Configure Git for Testing | Jürgen Gmach</title><meta name=keywords content="git,batou,testing"><meta name=description content="batou is a configuration management and deployment tool, comparable to Ansible.
With batou you can deploy applications, also from git repositories.
For this batou uses the git binary - so this has to be tested somehow.
One test looks like this&mldr;
def test_git_remote_init_pull(tmpdir): source = tmpdir.mkdir(&#34;source&#34;) dest = tmpdir.mkdir(&#34;dest&#34;) with source.as_cwd(): remote_core.cmd(&#34;git init&#34;) source.join(&#34;foo.txt&#34;).write(&#34;bar&#34;) remote_core.cmd(&#34;git add foo.txt&#34;) remote_core.cmd(&#34;git commit -m bar&#34;) remote_core.ensure_repository(str(dest), &#34;git-bundle&#34;) remote_core.git_pull_code(str(source), &#34;master&#34;) remote_core.git_update_working_copy(&#34;master&#34;) assert &#34;bar&#34; == dest.join(&#34;foo.txt&#34;).read() &mldr; and worked in some environments, even on Travis, but failed on my Ubuntu box, and later also on GH Actions:"><meta name=author content><link rel=canonical href=https://jugmac00.github.io/til/how-to-configure-git-for-testing/><link crossorigin=anonymous href=/assets/css/stylesheet.96771a12b249af1ff464eabdaa85d1a5268a4379a9f2da62cfd409656ff0233b.css integrity="sha256-lncaErJJrx/0ZOq9qoXRpSaKQ3mp8tpiz9QJZW/wIzs=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script><link rel=icon href=https://jugmac00.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://jugmac00.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://jugmac00.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://jugmac00.github.io/apple-touch-icon.png><link rel=mask-icon href=https://jugmac00.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="How to Configure Git for Testing"><meta property="og:description" content="batou is a configuration management and deployment tool, comparable to Ansible.
With batou you can deploy applications, also from git repositories.
For this batou uses the git binary - so this has to be tested somehow.
One test looks like this&mldr;
def test_git_remote_init_pull(tmpdir): source = tmpdir.mkdir(&#34;source&#34;) dest = tmpdir.mkdir(&#34;dest&#34;) with source.as_cwd(): remote_core.cmd(&#34;git init&#34;) source.join(&#34;foo.txt&#34;).write(&#34;bar&#34;) remote_core.cmd(&#34;git add foo.txt&#34;) remote_core.cmd(&#34;git commit -m bar&#34;) remote_core.ensure_repository(str(dest), &#34;git-bundle&#34;) remote_core.git_pull_code(str(source), &#34;master&#34;) remote_core.git_update_working_copy(&#34;master&#34;) assert &#34;bar&#34; == dest.join(&#34;foo.txt&#34;).read() &mldr; and worked in some environments, even on Travis, but failed on my Ubuntu box, and later also on GH Actions:"><meta property="og:type" content="article"><meta property="og:url" content="https://jugmac00.github.io/til/how-to-configure-git-for-testing/"><meta property="article:section" content="til"><meta property="article:published_time" content="2020-11-16T07:01:19+02:00"><meta property="article:modified_time" content="2020-11-16T07:01:19+02:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="How to Configure Git for Testing"><meta name=twitter:description content="batou is a configuration management and deployment tool, comparable to Ansible.
With batou you can deploy applications, also from git repositories.
For this batou uses the git binary - so this has to be tested somehow.
One test looks like this&mldr;
def test_git_remote_init_pull(tmpdir): source = tmpdir.mkdir(&#34;source&#34;) dest = tmpdir.mkdir(&#34;dest&#34;) with source.as_cwd(): remote_core.cmd(&#34;git init&#34;) source.join(&#34;foo.txt&#34;).write(&#34;bar&#34;) remote_core.cmd(&#34;git add foo.txt&#34;) remote_core.cmd(&#34;git commit -m bar&#34;) remote_core.ensure_repository(str(dest), &#34;git-bundle&#34;) remote_core.git_pull_code(str(source), &#34;master&#34;) remote_core.git_update_working_copy(&#34;master&#34;) assert &#34;bar&#34; == dest.join(&#34;foo.txt&#34;).read() &mldr; and worked in some environments, even on Travis, but failed on my Ubuntu box, and later also on GH Actions:"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Today I Learned","item":"https://jugmac00.github.io/til/"},{"@type":"ListItem","position":3,"name":"How to Configure Git for Testing","item":"https://jugmac00.github.io/til/how-to-configure-git-for-testing/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"How to Configure Git for Testing","name":"How to Configure Git for Testing","description":"batou is a configuration management and deployment tool, comparable to Ansible.\nWith batou you can deploy applications, also from git repositories.\nFor this batou uses the git binary - so this has to be tested somehow.\nOne test looks like this\u0026hellip;\ndef test_git_remote_init_pull(tmpdir): source = tmpdir.mkdir(\u0026#34;source\u0026#34;) dest = tmpdir.mkdir(\u0026#34;dest\u0026#34;) with source.as_cwd(): remote_core.cmd(\u0026#34;git init\u0026#34;) source.join(\u0026#34;foo.txt\u0026#34;).write(\u0026#34;bar\u0026#34;) remote_core.cmd(\u0026#34;git add foo.txt\u0026#34;) remote_core.cmd(\u0026#34;git commit -m bar\u0026#34;) remote_core.ensure_repository(str(dest), \u0026#34;git-bundle\u0026#34;) remote_core.git_pull_code(str(source), \u0026#34;master\u0026#34;) remote_core.git_update_working_copy(\u0026#34;master\u0026#34;) assert \u0026#34;bar\u0026#34; == dest.join(\u0026#34;foo.txt\u0026#34;).read() \u0026hellip; and worked in some environments, even on Travis, but failed on my Ubuntu box, and later also on GH Actions:","keywords":["git","batou","testing"],"articleBody":"batou is a configuration management and deployment tool, comparable to Ansible.\nWith batou you can deploy applications, also from git repositories.\nFor this batou uses the git binary - so this has to be tested somehow.\nOne test looks like this…\ndef test_git_remote_init_pull(tmpdir): source = tmpdir.mkdir(\"source\") dest = tmpdir.mkdir(\"dest\") with source.as_cwd(): remote_core.cmd(\"git init\") source.join(\"foo.txt\").write(\"bar\") remote_core.cmd(\"git add foo.txt\") remote_core.cmd(\"git commit -m bar\") remote_core.ensure_repository(str(dest), \"git-bundle\") remote_core.git_pull_code(str(source), \"master\") remote_core.git_update_working_copy(\"master\") assert \"bar\" == dest.join(\"foo.txt\").read() … and worked in some environments, even on Travis, but failed on my Ubuntu box, and later also on GH Actions:\nbatou.remote_core.CmdError: ('git commit -m bar', 128, b'', b'Author identity unknown\\n\\n*** Please tell me who you are.\\n\\nRun\\n\\n git config --global user.email \"you@example.com\"\\n git config --global user.name \"Your Name\"\\n\\nto set your account\\'s default identity.\\nOmit --global to set the identity only in this repository.\\n\\nfatal: empty ident name (for ) not allowed\\n') While this puzzled me for some time, there is a simple solution.\ngit pulls its configuration from various places, also from the environment!\ngit needs to be configured properly In order to use git, you need to configure it properly, ie set up an user and an email address.\none solution Basically, you need to both setup a committer and an author (difference).\nThis resulted in code like this…\n@mock.patch.dict( os.environ, { \"GIT_AUTHOR_EMAIL\": \"test@example.com\", \"GIT_COMMITTER_EMAIL\": \"test@example.com\", }, ) def test_git_remote_init_pull(tmpdir): ... This is ok for one or two tests, but if you have more tests, you should convert this into a fixture.\n@pytest.fixture def ensure_git_config(monkeypatch): monkeypatch.setitem(os.environ, \"GIT_AUTHOR_EMAIL\", \"test@example.com\") monkeypatch.setitem(os.environ, \"GIT_COMMITTER_EMAIL\", \"test@example.com\") So you can write your test as …\ndef test_git_remote_init_pull(tmpdir, ensure_git_config): ... or, if you want the configuration be set for all tests you can use autouse…\n@pytest.fixture(autouse=True) def ensure_git_config(monkeypatch): .... bonus: use git in CI If you directly use git, e.g. in your CI pipeline, you can use the following command:\ngit -c user.name ... -c user.email ... commit ... thanks Thanks to Anthony Sottile - once again!\n","wordCount":"319","inLanguage":"en","datePublished":"2020-11-16T07:01:19+02:00","dateModified":"2020-11-16T07:01:19+02:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://jugmac00.github.io/til/how-to-configure-git-for-testing/"},"publisher":{"@type":"Organization","name":"Jürgen Gmach","logo":{"@type":"ImageObject","url":"https://jugmac00.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add('dark'):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove('dark'):window.matchMedia('(prefers-color-scheme: dark)').matches&&document.body.classList.add('dark')</script><header class=header><nav class=nav><div class=logo><a href=https://jugmac00.github.io accesskey=h title="Jürgen Gmach (Alt + H)">Jürgen Gmach</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://jugmac00.github.io/about/ title=about><span>about</span></a></li><li><a href=https://jugmac00.github.io/blog/ title=blog><span>blog</span></a></li><li><a href=https://jugmac00.github.io/til/ title=til><span>today-i-learned</span></a></li><li><a href=https://jugmac00.github.io/talks/ title=talks><span>talks</span></a></li><li><a href=https://jugmac00.github.io/hiring/ title=hiring><span>hiring</span></a></li><li><a href=https://jugmac00.github.io/tags/ title=tags><span>tags</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>How to Configure Git for Testing</h1><div class=post-meta><span title="2020-11-16 07:01:19 +0200 +0200">November 16, 2020</span></div></header><div class=post-content><p><a href=https://batou.readthedocs.io/en/stable/>batou</a> is a configuration management and deployment tool,
comparable to <strong>Ansible</strong>.</p><p>With <strong>batou</strong> you can deploy applications,
also from <strong>git</strong> repositories.</p><p>For this <strong>batou</strong> uses the <strong>git</strong> binary - so this has to be tested somehow.</p><p>One test looks like this&mldr;</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>test_git_remote_init_pull</span>(tmpdir):
    source <span style=color:#f92672>=</span> tmpdir<span style=color:#f92672>.</span>mkdir(<span style=color:#e6db74>&#34;source&#34;</span>)
    dest <span style=color:#f92672>=</span> tmpdir<span style=color:#f92672>.</span>mkdir(<span style=color:#e6db74>&#34;dest&#34;</span>)
    <span style=color:#66d9ef>with</span> source<span style=color:#f92672>.</span>as_cwd():
        remote_core<span style=color:#f92672>.</span>cmd(<span style=color:#e6db74>&#34;git init&#34;</span>)
        source<span style=color:#f92672>.</span>join(<span style=color:#e6db74>&#34;foo.txt&#34;</span>)<span style=color:#f92672>.</span>write(<span style=color:#e6db74>&#34;bar&#34;</span>)
        remote_core<span style=color:#f92672>.</span>cmd(<span style=color:#e6db74>&#34;git add foo.txt&#34;</span>)
        remote_core<span style=color:#f92672>.</span>cmd(<span style=color:#e6db74>&#34;git commit -m bar&#34;</span>)

        remote_core<span style=color:#f92672>.</span>ensure_repository(str(dest), <span style=color:#e6db74>&#34;git-bundle&#34;</span>)
        remote_core<span style=color:#f92672>.</span>git_pull_code(str(source), <span style=color:#e6db74>&#34;master&#34;</span>)
        remote_core<span style=color:#f92672>.</span>git_update_working_copy(<span style=color:#e6db74>&#34;master&#34;</span>)

    <span style=color:#66d9ef>assert</span> <span style=color:#e6db74>&#34;bar&#34;</span> <span style=color:#f92672>==</span> dest<span style=color:#f92672>.</span>join(<span style=color:#e6db74>&#34;foo.txt&#34;</span>)<span style=color:#f92672>.</span>read()
</code></pre></div><p>&mldr; and worked in some environments,
even on <strong>Travis</strong>,
but failed on my Ubuntu box, and later also on GH Actions:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>batou.remote_core.CmdError: <span style=color:#f92672>(</span><span style=color:#e6db74>&#39;git commit -m bar&#39;</span>, 128, b<span style=color:#e6db74>&#39;&#39;</span>, b<span style=color:#e6db74>&#39;Author identity unknown\n\n*** Please tell me who you are.\n\nRun\n\n  git config --global user.email &#34;you@example.com&#34;\n  git config --global user.name &#34;Your Name&#34;\n\nto set your account\&#39;</span>s default identity.<span style=color:#ae81ff>\n</span>Omit --global to set the identity only in this repository.<span style=color:#ae81ff>\n\n</span>fatal: empty ident name <span style=color:#f92672>(</span><span style=color:#66d9ef>for</span> &lt;runner@fv-az18-857.2cpogp2qopau1j0uik42oh12ub.cx.internal.cloudapp.net&gt;<span style=color:#f92672>)</span> not allowed<span style=color:#ae81ff>\n</span><span style=color:#960050;background-color:#1e0010>&#39;</span><span style=color:#f92672>)</span>
</code></pre></div><p>While this puzzled me for some time,
there is a simple solution.</p><p><strong>git</strong> pulls its configuration from various places,
also from the environment!</p><h2 id=git-needs-to-be-configured-properly>git needs to be configured properly<a hidden class=anchor aria-hidden=true href=#git-needs-to-be-configured-properly>#</a></h2><p>In order to use git,
you need to configure it properly,
ie set up an user and an email address.</p><h3 id=one-solution>one solution<a hidden class=anchor aria-hidden=true href=#one-solution>#</a></h3><p>Basically, you need to both setup a committer and an author (<a href=https://stackoverflow.com/q/18750808/672833>difference</a>).</p><p>This resulted in code like this&mldr;</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#a6e22e>@mock.patch.dict</span>(
    os<span style=color:#f92672>.</span>environ,
    {
        <span style=color:#e6db74>&#34;GIT_AUTHOR_EMAIL&#34;</span>: <span style=color:#e6db74>&#34;test@example.com&#34;</span>,
        <span style=color:#e6db74>&#34;GIT_COMMITTER_EMAIL&#34;</span>: <span style=color:#e6db74>&#34;test@example.com&#34;</span>,
    },
)
<span style=color:#66d9ef>def</span> <span style=color:#a6e22e>test_git_remote_init_pull</span>(tmpdir):
   <span style=color:#f92672>...</span>
</code></pre></div><p>This is ok for one or two tests,
but if you have more tests,
you should convert this into a fixture.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#a6e22e>@pytest.fixture</span>
<span style=color:#66d9ef>def</span> <span style=color:#a6e22e>ensure_git_config</span>(monkeypatch):
    monkeypatch<span style=color:#f92672>.</span>setitem(os<span style=color:#f92672>.</span>environ, <span style=color:#e6db74>&#34;GIT_AUTHOR_EMAIL&#34;</span>, <span style=color:#e6db74>&#34;test@example.com&#34;</span>)
    monkeypatch<span style=color:#f92672>.</span>setitem(os<span style=color:#f92672>.</span>environ, <span style=color:#e6db74>&#34;GIT_COMMITTER_EMAIL&#34;</span>, <span style=color:#e6db74>&#34;test@example.com&#34;</span>)
</code></pre></div><p>So you can write your test as &mldr;</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>test_git_remote_init_pull</span>(tmpdir, ensure_git_config):
    <span style=color:#f92672>...</span>
</code></pre></div><p>or, if you want the configuration be set for all tests you can use <code>autouse</code>&mldr;</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#a6e22e>@pytest.fixture</span>(autouse<span style=color:#f92672>=</span>True)
<span style=color:#66d9ef>def</span> <span style=color:#a6e22e>ensure_git_config</span>(monkeypatch):
    <span style=color:#f92672>....</span>
</code></pre></div><h2 id=bonus-use-git-in-ci>bonus: use <code>git</code> in CI<a hidden class=anchor aria-hidden=true href=#bonus-use-git-in-ci>#</a></h2><p>If you directly use <code>git</code>,
e.g. in your CI pipeline,
you can use the following command:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>git -c user.name ... -c user.email ... commit ...
</code></pre></div><h2 id=thanks>thanks<a hidden class=anchor aria-hidden=true href=#thanks>#</a></h2><p>Thanks to <a href=https://twitter.com/codewithanthony/status/1327661351230050304>Anthony Sottile</a> - once again!</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://jugmac00.github.io/tags/git/>git</a></li><li><a href=https://jugmac00.github.io/tags/batou/>batou</a></li><li><a href=https://jugmac00.github.io/tags/testing/>testing</a></li></ul></footer></article></main><footer class=footer><span>&copy; 2022 <a href=https://jugmac00.github.io>Jürgen Gmach</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById('menu');menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(a=>{a.addEventListener("click",function(b){b.preventDefault();var a=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView({behavior:"smooth"}),a==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${a}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove('dark'),localStorage.setItem("pref-theme",'light')):(document.body.classList.add('dark'),localStorage.setItem("pref-theme",'dark'))})</script></body></html>