<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Bye-Bye python-memcached, hello pymemcache | Jürgen Gmach</title><meta name=keywords content="python,memcached,pymemcache,unmaintained"><meta name=description content="For one app that I help maintaining I noticed that python-memcached was used, which has not been updated in several years.
There were some efforts to transfer python-memcached to a new maintainer, but at the end that did not work out.
So, the project is dead.
While an unmaintained project may currently work, there are several things to consider:
 there may be bugs which do not get fixed there may be security issues which do not get fixed it may stop working for e."><meta name=author content><link rel=canonical href=https://jugmac00.github.io/blog/bye-bye-python-memcached-hello-pymemcache/><link crossorigin=anonymous href=/assets/css/stylesheet.min.309a3942f890eb0930959205be1f692b2f0e85115a8b0190361a25a37e54fffa.css integrity="sha256-MJo5QviQ6wkwlZIFvh9pKy8OhRFaiwGQNholo35U//o=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.min.7680afc38aa6b15ddf158a4f3780b7b1f7dde7e91d26f073e6229bb7a0793c92.js integrity="sha256-doCvw4qmsV3fFYpPN4C3sffd5+kdJvBz5iKbt6B5PJI=" onload=hljs.initHighlightingOnLoad()></script><link rel=icon href=https://jugmac00.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://jugmac00.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://jugmac00.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://jugmac00.github.io/apple-touch-icon.png><link rel=mask-icon href=https://jugmac00.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><meta name=generator content="Hugo 0.82.0"><meta property="og:title" content="Bye-Bye python-memcached, hello pymemcache"><meta property="og:description" content="For one app that I help maintaining I noticed that python-memcached was used, which has not been updated in several years.
There were some efforts to transfer python-memcached to a new maintainer, but at the end that did not work out.
So, the project is dead.
While an unmaintained project may currently work, there are several things to consider:
 there may be bugs which do not get fixed there may be security issues which do not get fixed it may stop working for e."><meta property="og:type" content="article"><meta property="og:url" content="https://jugmac00.github.io/blog/bye-bye-python-memcached-hello-pymemcache/"><meta property="article:section" content="blog"><meta property="article:published_time" content="2021-11-09T11:40:26+01:00"><meta property="article:modified_time" content="2021-11-09T11:40:26+01:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Bye-Bye python-memcached, hello pymemcache"><meta name=twitter:description content="For one app that I help maintaining I noticed that python-memcached was used, which has not been updated in several years.
There were some efforts to transfer python-memcached to a new maintainer, but at the end that did not work out.
So, the project is dead.
While an unmaintained project may currently work, there are several things to consider:
 there may be bugs which do not get fixed there may be security issues which do not get fixed it may stop working for e."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Blogs","item":"https://jugmac00.github.io/blog/"},{"@type":"ListItem","position":3,"name":"Bye-Bye python-memcached, hello pymemcache","item":"https://jugmac00.github.io/blog/bye-bye-python-memcached-hello-pymemcache/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Bye-Bye python-memcached, hello pymemcache","name":"Bye-Bye python-memcached, hello pymemcache","description":"For one app that I help maintaining I noticed that python-memcached was used, which has not been updated in several years.\nThere were some efforts to transfer python-memcached to a new maintainer, but at the end that did not work out.\nSo, the project is dead.\nWhile an unmaintained project may currently work, there are several things to consider:\n there may be bugs which do not get fixed there may be security issues which do not get fixed it may stop working for e.","keywords":["python","memcached","pymemcache","unmaintained"],"articleBody":"For one app that I help maintaining I noticed that python-memcached was used, which has not been updated in several years.\nThere were some efforts to transfer python-memcached to a new maintainer, but at the end that did not work out.\nSo, the project is dead.\nWhile an unmaintained project may currently work, there are several things to consider:\n there may be bugs which do not get fixed there may be security issues which do not get fixed it may stop working for e.g. a new Python version  So something needed to be done!\nLuckily, with pymemcache there is a successor, even backed by a big company.\nOne of the contributors of the successor even put some effort into making it largely compatible.\nSo, as a first step I updated the app’s dependencies from python-memcached to pymemcache.\nIn the build configuration (e.g. setup.py, setup.cfg, pyproject.toml…) I swapped the names, and as this is an application, I also updated the requirements.txt.\nAre we there yet? Not so fast.\nFirst, I needed to figure out what needed to be done to the imports.\nThe package is all about creating a connection to a memcached server, so I had to have a look at the Client class.\nFor python-memcached the import statement is:\nfrom memcache import Client  Have you noticed? It is not called from python_memcached import Client! While the package name in e.g. setup.py (and thus for PyPI) and the package name from the source code are usually the same, that is not necessary.\n For pymemcache it is… wait. There is more than one Client class.\nThere is pymemcache.client.base.Client, pymemcache.client.hash.HashClient… and some more.\nAs the first one is meant to be able to only connect to one server, I chose the latter one.\nSignature has changed Luckily, we have a fairly strong test suite, so after updating the import statements, I knew that the test suite would drive my migration attempts.\nThe first problem was…\nTypeError: set() got an unexpected keyword argument 'min_compress_len' The signature for Client.set has changed - min_compress_len is no more.\nThere was not much to do, except reading the docstring of python-memcached’s Client.set.\nI decided to just drop it, as there is no replacement.\nNext one, please TypeError: set() got an unexpected keyword argument 'time' When I compared the old and the new library, I noticed that the time argument is now called expire.\nSo I just needed to update that - for all callers!\nAlso, expire needs to be an int, whereas time also accepted a float type.\nNo more debug The next problem was a connection problem of the client to the server.\nI used pdbpp to have a look what was going on:\nPassing [('127.0.0.1:11242', 1)] to a Client’s init (python-memcached) worked, as 1 is recognized as debug flag, but pymemcache dropped that argument.\npymemcache can handle different formats, so I used a list of strings:\n['127.0.0.1:11242'] Connection refused Oh my!\nThe next one was really tough.\nConnectionRefusedError: [Errno 111] Connection refused No matter what I tried, I could not connect to the server, but only from within a test.\nSo, I had a hunch that this was about the test setup.\nAs I got stuck, I asked a colleague for help, who pointed me out to a pattern we use in the test setup.\nDuring the test setup we try to set a value via HashClient.set to check whether the server is up already.\nWhile python-memcached returned an int, pymemcache raises an exception when the server is not yet available, which I needed to catch now.\nForget Dead Hosts Next one…\nAttributeError: 'HashClient' object has no attribute 'forget_dead_hosts' Same as above for min_compress_len, this member has gone and after reading its docstring I decided to drop it, especially as it was only called in our test code.\nThe end is near The test suite now ran with 3 failures and 1 error.\nAttributeError: 'HashClient' object has no attribute 'MemcachedKeyCharacterError' Reading some old code comments, it looks like my predecessors had been bitten by a bug in python-memcached, which allowed spaces in keys, so a regression test was written.\npymemcache decided to both move and rename the exception.\nMemcachedKeyCharacterError - MemcacheIllegalInputError\nLast but not least The last three failures had the same reason:\ntesttools.matchers._impl.MismatchError: b'somevalue' != 'somevalue' Oh wow! Instead of strings, we now got bytes!\nI had a look at pymemcache’s documentation and it looks like this behavior is intended… wat?\n from pymemcache.client.base import Client  client = Client('127.0.0.1')  client.set('some_key', 'some_value') True  client.get('some_key') b'some_value' I tried to find a reason for this behavior, but without success.\nI really hope a reader can shed some light into this.\nEven more confusing, I found a blog post at Real Python, where the example code showed a behavior I would expect, ie string in - string out.\nSo, something was wrong here.\nDigging in pymemcache’s source code and its documentation I had a hunch that this had something to do with serializing and deserializing the data.\nThe solution was to pass in both a serializer and a deserializer when initializing a HashClient object:\nfrom pymemcache.client.hash import HashClient from pymemcache.serde import python_memcache_deserializer from pymemcache.serde import python_memcache_serializer HashClient( servers, serializer=python_memcache_serializer, deserializer=python_memcache_deserializer) The End I hope this migration guide will help someone out there with a similar task.\nI also hope the maintainers of pymemcache consider linking to this blog post :-)\nUpdates 2021-12-08   add note that expire needs to be an int, no longer a float\n  after the deployment of the migration, we noticed a couple of problems, which boiled down to the fact, that pymemcache is less lenient to possible problems as it only catches selected exceptions, and re-raises the rest, so you need to take care of exception handling in your code!\n  ","wordCount":"958","inLanguage":"en","datePublished":"2021-11-09T11:40:26+01:00","dateModified":"2021-11-09T11:40:26+01:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://jugmac00.github.io/blog/bye-bye-python-memcached-hello-pymemcache/"},"publisher":{"@type":"Organization","name":"Jürgen Gmach","logo":{"@type":"ImageObject","url":"https://jugmac00.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add('dark'):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove('dark'):window.matchMedia('(prefers-color-scheme: dark)').matches&&document.body.classList.add('dark')</script><noscript><style type=text/css>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:#1d1e20;--entry:#2e2e33;--primary:rgba(255, 255, 255, 0.84);--secondary:rgba(255, 255, 255, 0.56);--tertiary:rgba(255, 255, 255, 0.16);--content:rgba(255, 255, 255, 0.74);--hljs-bg:#2e2e33;--code-bg:#37383e;--border:#333}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><header class=header><nav class=nav><div class=logo><a href=https://jugmac00.github.io accesskey=h title="Jürgen Gmach (Alt + H)">Jürgen Gmach</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://jugmac00.github.io/about/ title=about><span>about</span></a></li><li><a href=https://jugmac00.github.io/blog/ title=blog><span>blog</span></a></li><li><a href=https://jugmac00.github.io/til/ title=til><span>today-i-learned</span></a></li><li><a href=https://jugmac00.github.io/talks/ title=talks><span>talks</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>Bye-Bye python-memcached, hello pymemcache</h1><div class=post-meta>November 9, 2021</div></header><div class=post-content><p>For one app that I help maintaining I noticed that <strong>python-memcached</strong> was used, which has not been updated in several years.</p><p>There were some efforts <a href=https://github.com/linsomniac/python-memcached/issues/95>to transfer python-memcached</a> to a new maintainer,
but at the end that did not work out.</p><p>So, <a href=https://github.com/linsomniac/python-memcached/issues/177>the project is dead</a>.</p><p>While an unmaintained project may currently work,
there are several things to consider:</p><ul><li>there may be bugs which do not get fixed</li><li>there may be security issues which do not get fixed</li><li>it may stop working for e.g. a new Python version</li></ul><p>So something needed to be done!</p><p>Luckily,
with <a href=https://pypi.org/project/pymemcache/>pymemcache</a> there is a successor,
even backed by a big company.</p><p>One of the contributors of the successor even put some effort into <a href=https://github.com/linsomniac/python-memcached/issues/177#issuecomment-744345125>making it largely compatible</a>.</p><p>So, as a first step I updated the app&rsquo;s dependencies from <strong>python-memcached</strong> to <strong>pymemcache</strong>.</p><p>In the build configuration (e.g. <code>setup.py</code>, <code>setup.cfg</code>, <code>pyproject.toml</code>&mldr;) I swapped the names,
and as this is an application, I also updated the <code>requirements.txt</code>.</p><h2 id=are-we-there-yet>Are we there yet?<a hidden class=anchor aria-hidden=true href=#are-we-there-yet>#</a></h2><p>Not so fast.</p><p>First, I needed to figure out what needed to be done to the imports.</p><p>The package is all about creating a connection to a <a href=https://memcached.org/>memcached</a> server,
so I had to have a look at the <code>Client</code> class.</p><p>For <strong>python-memcached</strong> the import statement is:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#f92672>from</span> memcache <span style=color:#f92672>import</span> Client
</code></pre></div><blockquote><p>Have you noticed?
It is not called <code>from python_memcached import Client</code>!
While the package name in e.g. setup.py (and thus for PyPI)
and the package name from the source code are usually the same,
that is not necessary.</p></blockquote><p>For <strong>pymemcache</strong> it is&mldr; wait. There is more than one <code>Client</code> class.</p><p>There is <code>pymemcache.client.base.Client</code>, <code>pymemcache.client.hash.HashClient</code>&mldr; and some more.</p><p>As the first one is meant to be able to only connect to one server,
I chose the latter one.</p><h2 id=signature-has-changed>Signature has changed<a hidden class=anchor aria-hidden=true href=#signature-has-changed>#</a></h2><p>Luckily,
we have a fairly strong test suite,
so after updating the import statements,
I knew that the test suite would drive my migration attempts.</p><p>The first problem was&mldr;</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#a6e22e>TypeError</span>: set() got an unexpected keyword argument <span style=color:#e6db74>&#39;min_compress_len&#39;</span>
</code></pre></div><p>The signature for <code>Client.set</code> has changed - <code>min_compress_len</code> is no more.</p><p>There was not much to do,
except reading the docstring of <strong>python-memcached</strong>&rsquo;s <code>Client.set</code>.</p><p>I decided to just drop it,
as there is no replacement.</p><h2 id=next-one-please>Next one, please<a hidden class=anchor aria-hidden=true href=#next-one-please>#</a></h2><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#a6e22e>TypeError</span>: set() got an unexpected keyword argument <span style=color:#e6db74>&#39;time&#39;</span>
</code></pre></div><p>When I compared the old and the new library,
I noticed that the <code>time</code> argument is now called <code>expire</code>.</p><p>So I just needed to update that - for all callers!</p><p>Also, <code>expire</code> needs to be an int,
whereas <code>time</code> also accepted a <code>float</code> type.</p><h2 id=no-more-debug>No more debug<a hidden class=anchor aria-hidden=true href=#no-more-debug>#</a></h2><p>The next problem was a connection problem of the client to the server.</p><p>I used <a href=https://pypi.org/project/pdbpp/>pdbpp</a> to have a look what was going on:</p><p>Passing <code>[('127.0.0.1:11242', 1)]</code> to a <code>Client</code>&rsquo;s init (<strong>python-memcached</strong>) worked,
as <code>1</code> is recognized as debug flag,
but <strong>pymemcache</strong> dropped that argument.</p><p><strong>pymemcache</strong> can handle different <a href=https://github.com/pinterest/pymemcache/blob/79d98d23cd589556b0dc51a7d10ea338e90a944e/pymemcache/client/base.py#L120-L138>formats</a>,
so I used a list of strings:</p><pre><code>['127.0.0.1:11242']
</code></pre><h2 id=connection-refused>Connection refused<a hidden class=anchor aria-hidden=true href=#connection-refused>#</a></h2><p>Oh my!</p><p>The next one was really tough.</p><pre><code>ConnectionRefusedError: [Errno 111] Connection refused
</code></pre><p>No matter what I tried,
I could not connect to the server,
but only from within a test.</p><p>So, I had a hunch that this was about the test setup.</p><p>As I got stuck,
I asked a colleague for help,
who pointed me out to a pattern we use in the test setup.</p><p>During the test setup we try to set a value via <code>HashClient.set</code> to check whether the server is up already.</p><p>While <code>python-memcached</code> returned an int,
<code>pymemcache</code> raises an exception when the server is not yet available,
which I needed to catch now.</p><h2 id=forget-dead-hosts>Forget Dead Hosts<a hidden class=anchor aria-hidden=true href=#forget-dead-hosts>#</a></h2><p>Next one&mldr;</p><pre><code>AttributeError: 'HashClient' object has no attribute 'forget_dead_hosts'
</code></pre><p>Same as above for <code>min_compress_len</code>,
this member has gone and after reading its docstring I decided to drop it,
especially as it was only called in our test code.</p><h2 id=the-end-is-near>The end is near<a hidden class=anchor aria-hidden=true href=#the-end-is-near>#</a></h2><p>The test suite now ran with 3 failures and 1 error.</p><pre><code>AttributeError: 'HashClient' object has no attribute 'MemcachedKeyCharacterError'
</code></pre><p>Reading some old code comments, it looks like my predecessors had been bitten by a bug in <strong>python-memcached</strong>,
which allowed spaces in keys, so a regression test was written.</p><p><strong>pymemcache</strong> decided to both move and rename the exception.</p><p><code>MemcachedKeyCharacterError</code> -> <code>MemcacheIllegalInputError</code></p><h2 id=last-but-not-least>Last but not least<a hidden class=anchor aria-hidden=true href=#last-but-not-least>#</a></h2><p>The last three failures had the same reason:</p><pre><code>testtools.matchers._impl.MismatchError: b'somevalue' != 'somevalue'
</code></pre><p>Oh wow! Instead of strings, we now got bytes!</p><p>I had a look at pymemcache&rsquo;s <a href=https://pymemcache.readthedocs.io/en/latest/getting_started.html#interacting-with-pymemcache>documentation</a>
and it looks like this behavior is intended&mldr; wat?</p><pre><code>&gt;&gt;&gt; from pymemcache.client.base import Client
&gt;&gt;&gt; client = Client('127.0.0.1')
&gt;&gt;&gt; client.set('some_key', 'some_value')
True
&gt;&gt;&gt; client.get('some_key')
b'some_value'
</code></pre><p>I tried to find a reason for this behavior,
but without success.</p><p>I really hope a reader can shed some light into this.</p><p>Even more confusing, I found a <a href=https://realpython.com/python-memcache-efficient-caching/#storing-and-retrieving-cached-values-using-python>blog post</a> at Real Python,
where the example code showed a behavior I would expect, ie string in -> string out.</p><p>So, something was wrong here.</p><p>Digging in <strong>pymemcache</strong>&rsquo;s source code and its documentation
I had a hunch that this had something to do with serializing and deserializing the data.</p><p>The solution was to pass in both a serializer and a deserializer when initializing a <code>HashClient</code> object:</p><pre><code>from pymemcache.client.hash import HashClient

from pymemcache.serde import python_memcache_deserializer
from pymemcache.serde import python_memcache_serializer


HashClient(
    servers,
    serializer=python_memcache_serializer,
    deserializer=python_memcache_deserializer)
</code></pre><h1 id=the-end>The End<a hidden class=anchor aria-hidden=true href=#the-end>#</a></h1><p>I hope this migration guide will help someone out there with a similar task.</p><p>I also hope the maintainers of <code>pymemcache</code> consider linking to this blog post :-)</p><h2 id=updates>Updates<a hidden class=anchor aria-hidden=true href=#updates>#</a></h2><h3 id=2021-12-08>2021-12-08<a hidden class=anchor aria-hidden=true href=#2021-12-08>#</a></h3><ul><li><p>add note that <code>expire</code> needs to be an <code>int</code>, no longer a <code>float</code></p></li><li><p>after the deployment of the migration, we noticed a couple of problems,
which boiled down to the fact,
that pymemcache is less lenient to possible problems
as it only catches selected exceptions,
and <a href=https://github.com/pinterest/pymemcache/blob/88ae513f6587dfbc3a58de9ca575e6be4338450a/pymemcache/client/base.py#L1110-L1112>re-raises the rest</a>,
so you need to take care of exception handling in your code!</p></li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=https://jugmac00.github.io/tags/python/>python</a></li><li><a href=https://jugmac00.github.io/tags/memcached/>memcached</a></li><li><a href=https://jugmac00.github.io/tags/pymemcache/>pymemcache</a></li><li><a href=https://jugmac00.github.io/tags/unmaintained/>unmaintained</a></li></ul></footer></article></main><footer class=footer><span>&copy; 2021 <a href=https://jugmac00.github.io>Jürgen Gmach</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)"><button class=top-link id=top-link type=button accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></button></a>
<script>let menu=document.getElementById('menu');menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)},document.querySelectorAll('a[href^="#"]').forEach(a=>{a.addEventListener("click",function(b){b.preventDefault();var a=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView({behavior:"smooth"}),a==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${a}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove('dark'),localStorage.setItem("pref-theme",'light')):(document.body.classList.add('dark'),localStorage.setItem("pref-theme",'dark'))})</script></body></html>