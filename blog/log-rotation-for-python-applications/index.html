<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Log Rotation for Python Applications - Without killing them softly | Jürgen Gmach</title>
<meta name=keywords content><meta name=description content="A couple of days after a successful deployment of my Zope 4 application, I noticed something worrisome.
Zope gets killed every night, shortly after midnight.
I use Supervisor, which monitors the process and restarts it, so that&rsquo;s not the problem.
But there are two problems:
I did not trigger this on purpose. The cache of my app is cold, that means that my colleagues get slow response times for the first queries in the morning."><meta name=author content><link rel=canonical href=https://jugmac00.github.io/blog/log-rotation-for-python-applications/><link crossorigin=anonymous href=/assets/css/stylesheet.b609c58d5c11bb90b1a54e04005d74ad1ddf22165eb79f5533967e57df9c3b50.css integrity="sha256-tgnFjVwRu5CxpU4EAF10rR3fIhZet59VM5Z+V9+cO1A=" rel="preload stylesheet" as=style><link rel=icon href=https://jugmac00.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://jugmac00.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://jugmac00.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://jugmac00.github.io/apple-touch-icon.png><link rel=mask-icon href=https://jugmac00.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://jugmac00.github.io/blog/log-rotation-for-python-applications/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="Log Rotation for Python Applications - Without killing them softly"><meta property="og:description" content="A couple of days after a successful deployment of my Zope 4 application, I noticed something worrisome.
Zope gets killed every night, shortly after midnight.
I use Supervisor, which monitors the process and restarts it, so that&rsquo;s not the problem.
But there are two problems:
I did not trigger this on purpose. The cache of my app is cold, that means that my colleagues get slow response times for the first queries in the morning."><meta property="og:type" content="article"><meta property="og:url" content="https://jugmac00.github.io/blog/log-rotation-for-python-applications/"><meta property="article:section" content="blog"><meta property="article:published_time" content="2020-04-08T14:20:11+02:00"><meta property="article:modified_time" content="2020-04-08T14:20:11+02:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Log Rotation for Python Applications - Without killing them softly"><meta name=twitter:description content="A couple of days after a successful deployment of my Zope 4 application, I noticed something worrisome.
Zope gets killed every night, shortly after midnight.
I use Supervisor, which monitors the process and restarts it, so that&rsquo;s not the problem.
But there are two problems:
I did not trigger this on purpose. The cache of my app is cold, that means that my colleagues get slow response times for the first queries in the morning."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Blogs","item":"https://jugmac00.github.io/blog/"},{"@type":"ListItem","position":2,"name":"Log Rotation for Python Applications - Without killing them softly","item":"https://jugmac00.github.io/blog/log-rotation-for-python-applications/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Log Rotation for Python Applications - Without killing them softly","name":"Log Rotation for Python Applications - Without killing them softly","description":"A couple of days after a successful deployment of my Zope 4 application, I noticed something worrisome.\nZope gets killed every night, shortly after midnight.\nI use Supervisor, which monitors the process and restarts it, so that\u0026rsquo;s not the problem.\nBut there are two problems:\nI did not trigger this on purpose. The cache of my app is cold, that means that my colleagues get slow response times for the first queries in the morning.","keywords":[],"articleBody":"A couple of days after a successful deployment of my Zope 4 application, I noticed something worrisome.\nZope gets killed every night, shortly after midnight.\nI use Supervisor, which monitors the process and restarts it, so that’s not the problem.\nBut there are two problems:\nI did not trigger this on purpose. The cache of my app is cold, that means that my colleagues get slow response times for the first queries in the morning. What’s wrong? Thanks to version controlled configuration management it was not hard to pick up a trail of the problem.\nThe commit which looked most promising was one about introducing proper log rotation with Logrotate.\nLogrotate manages automatic rotation and compression of your log files.\nLog rotation was setup to send a signal to Zope to close and re-open the log file as following:\n/srv/app/deployment/work/zope/var/log/instance*.log { postrotate kill -USR2 $(cat /srv/app/deployment/work/zope/var/instance/Z4.pid) endscript } kill sounds scary at first, but it isn’t, or let’s say, it shouldn’t be.\nIt just sends a signal to a process - and USR2 happens to be a signal for which your application can use a customized reaction, e.g. log close and re-open.\nLooking at Zope’s documentation, this is exactly how it should look like and it definitely used to work this way back then with Zope 2. No mentions in the Zope documentation about a change.\nSIGUSR2 close and re-open all Zope log files (z2.log, event log, detailed log.) The common idiom after rotating Zope log files is:: kill -USR2 `cat $ZOPE_HOME/var/Z2.pid` This excerpt was available under https://zope.readthedocs.io/en/latest/INSTALL.html - meanwhile it was updated.\nSo, this looks like a Zope bug, eh?\nMinimal setup to reproduce it… yep, Zope dies.\nSome back and forth between Zope’s and Waitress’ (WSGI server) maintainers about who should fix this, and… there is nothing to fix.\nZope decided to drop signal handling with the 2 to 4 update, and Waitress can’t do it as it does not handle log files.\nExcuse me, sir. What is the real problem here? When Logrotate archives the current log file, and creates a new one, the current app’s process keeps the handle to the original file, and keeps logging into it, although there is a new one.\nUsually, you can restart your app or send a special signal, like USR2 to your app to fix this problem, but as outlined above, both options do not work out great with my use case.\nSo, what to do? Turns out, there are many options!\nlog to a supervising process use Logrotate’s copytruncate directive use Python’s WatchedFileHandler Having used Python for more than a decade, I still get surprised by gems in the standard library I never heard of before. Just like the WatchedFileHandler.\nWhile all three options are valid, the WatchedFileHandler just does what is needed here. Watch the file for a change, then close the old file stream and open a new one.\nThe final “configuration” of Logrotate is this simple:\n/srv/app/deployment/work/zope/var/log/*.log { } ","wordCount":"494","inLanguage":"en","datePublished":"2020-04-08T14:20:11+02:00","dateModified":"2020-04-08T14:20:11+02:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://jugmac00.github.io/blog/log-rotation-for-python-applications/"},"publisher":{"@type":"Organization","name":"Jürgen Gmach","logo":{"@type":"ImageObject","url":"https://jugmac00.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://jugmac00.github.io/ accesskey=h title="Jürgen Gmach (Alt + H)">Jürgen Gmach</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://jugmac00.github.io/about/ title=about><span>about</span></a></li><li><a href=https://jugmac00.github.io/blog/ title=blog><span>blog</span></a></li><li><a href=https://jugmac00.github.io/til/ title=til><span>today-i-learned</span></a></li><li><a href=https://jugmac00.github.io/talks/ title=talks><span>talks</span></a></li><li><a href=https://jugmac00.github.io/hiring/ title=hiring><span>hiring</span></a></li><li><a href=https://jugmac00.github.io/tags/ title=tags><span>tags</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">Log Rotation for Python Applications - Without killing them softly</h1><div class=post-meta><span title='2020-04-08 14:20:11 +0200 +0200'>April 8, 2020</span></div></header><div class=post-content><p>A couple of days after a successful deployment of my <a href=https://zope.readthedocs.io/en/latest/>Zope 4</a> application,
I noticed something worrisome.</p><p>Zope gets killed every night, shortly after midnight.</p><p>I use <a href=http://supervisord.org/>Supervisor</a>,
which monitors the process and restarts it, so that&rsquo;s not the problem.</p><p>But there are two problems:</p><ul><li>I did not trigger this on purpose.</li><li>The cache of my app is cold,
that means that my colleagues get slow response times for the first queries in the morning.</li></ul><h2 id=whats-wrong>What&rsquo;s wrong?<a hidden class=anchor aria-hidden=true href=#whats-wrong>#</a></h2><p>Thanks to version controlled <a href=https://batou.readthedocs.io/en/latest/>configuration management</a> it was not hard to pick up a trail of the problem.</p><p>The commit which looked most promising was one about introducing proper log rotation with <code>Logrotate</code>.</p><p><code>Logrotate</code> manages automatic rotation and compression of your log files.</p><p>Log rotation was setup to send a signal to Zope to close and re-open the log file as following:</p><pre tabindex=0><code class=language-logrotate data-lang=logrotate>/srv/app/deployment/work/zope/var/log/instance*.log  {

postrotate
kill -USR2 $(cat /srv/app/deployment/work/zope/var/instance/Z4.pid)
endscript
}
</code></pre><p><code>kill</code> sounds scary at first, but it isn&rsquo;t, or let&rsquo;s say, it shouldn&rsquo;t be.</p><p>It just sends a signal to a process -
and <code>USR2</code> happens to be a signal for which your application can use a customized reaction,
e.g. log close and re-open.</p><p>Looking at Zope&rsquo;s documentation,
this is exactly how it should look like and it definitely used to work this way back then with Zope 2.
No mentions in the Zope documentation about a change.</p><pre tabindex=0><code class=language-documentation data-lang=documentation>SIGUSR2
  close and re-open all Zope log files (z2.log, event log, detailed log.) The
  common idiom after rotating Zope log files is::

    kill -USR2 `cat $ZOPE_HOME/var/Z2.pid`
</code></pre><p>This excerpt was available under <a href=https://zope.readthedocs.io/en/latest/INSTALL.html>https://zope.readthedocs.io/en/latest/INSTALL.html</a> - meanwhile it was updated.</p><p>So, this looks like a Zope bug, eh?</p><p>Minimal setup to reproduce it&mldr; yep, Zope dies.</p><p>Some back and forth between Zope&rsquo;s and Waitress&rsquo; (WSGI server) maintainers about who should fix this,
and&mldr; there is nothing to fix.</p><p><strong>Zope decided to drop signal handling</strong> with the 2 to 4 update,
and Waitress can&rsquo;t do it as it does not handle log files.</p><h2 id=excuse-me-sir-what-is-the-real-problem-here>Excuse me, sir. What is the real problem here?<a hidden class=anchor aria-hidden=true href=#excuse-me-sir-what-is-the-real-problem-here>#</a></h2><p>When <code>Logrotate</code> archives the current log file, and creates a new one,
the current app&rsquo;s process keeps the handle to the original file,
and keeps logging into it, although there is a new one.</p><p>Usually, you can restart your app or send a special signal,
like USR2 to your app to fix this problem, but as outlined above,
both options do not work out great with my use case.</p><h2 id=so-what-to-do>So, what to do?<a hidden class=anchor aria-hidden=true href=#so-what-to-do>#</a></h2><p>Turns out, there are many options!</p><ul><li>log to a supervising process</li><li>use <code>Logrotate</code>&rsquo;s <a href=https://jlk.fjfi.cvut.cz/arch/manpages/man/logrotate.8#Files_and_Folders><code>copytruncate</code></a> directive</li><li>use Python&rsquo;s <a href=https://docs.python.org/3/library/logging.handlers.html#watchedfilehandler><code>WatchedFileHandler</code></a></li></ul><p>Having used Python for more than a decade,
I still get surprised by gems in the standard library I never heard of before.
Just like the <code>WatchedFileHandler</code>.</p><p>While all three options are valid,
the <code>WatchedFileHandler</code> just does what is needed here.
Watch the file for a change, then close the old file stream and open a new one.</p><p>The final &ldquo;configuration&rdquo; of <code>Logrotate</code> is this simple:</p><pre tabindex=0><code class=language-configuration data-lang=configuration>/srv/app/deployment/work/zope/var/log/*.log  {

}
</code></pre></div><footer class=post-footer><ul class=post-tags></ul></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://jugmac00.github.io/>Jürgen Gmach</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>