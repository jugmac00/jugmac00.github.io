<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Enrich Test Coverage With Contexts | Jürgen Gmach</title><meta name=keywords content><meta name=description content="Hold on tight, now I expect a lot of us:
We all
 test our code use coverage strive for 100% test coverage  So, what&rsquo;s missing?
I miss some context 100% test coverage is great, but sometimes we need more information.
e.g. which test covers line XXX?
In sufficiently complex code bases, with mixed unit and integration tests, this is no longer easy to find out.
Sure, you can set a breakpoint and run your tests and wait until the breakpoint has been hit."><meta name=author content><link rel=canonical href=https://jugmac00.github.io/blog/enrich-test-coverage-with-contexts/><link crossorigin=anonymous href=/assets/css/stylesheet.min.309a3942f890eb0930959205be1f692b2f0e85115a8b0190361a25a37e54fffa.css integrity="sha256-MJo5QviQ6wkwlZIFvh9pKy8OhRFaiwGQNholo35U//o=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.min.7680afc38aa6b15ddf158a4f3780b7b1f7dde7e91d26f073e6229bb7a0793c92.js integrity="sha256-doCvw4qmsV3fFYpPN4C3sffd5+kdJvBz5iKbt6B5PJI=" onload=hljs.initHighlightingOnLoad()></script><link rel=icon href=https://jugmac00.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://jugmac00.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://jugmac00.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://jugmac00.github.io/apple-touch-icon.png><link rel=mask-icon href=https://jugmac00.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><meta name=generator content="Hugo 0.82.0"><meta property="og:title" content="Enrich Test Coverage With Contexts"><meta property="og:description" content="Hold on tight, now I expect a lot of us:
We all
 test our code use coverage strive for 100% test coverage  So, what&rsquo;s missing?
I miss some context 100% test coverage is great, but sometimes we need more information.
e.g. which test covers line XXX?
In sufficiently complex code bases, with mixed unit and integration tests, this is no longer easy to find out.
Sure, you can set a breakpoint and run your tests and wait until the breakpoint has been hit."><meta property="og:type" content="article"><meta property="og:url" content="https://jugmac00.github.io/blog/enrich-test-coverage-with-contexts/"><meta property="article:section" content="blog"><meta property="article:published_time" content="2021-05-20T14:22:51+02:00"><meta property="article:modified_time" content="2021-05-20T14:22:51+02:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Enrich Test Coverage With Contexts"><meta name=twitter:description content="Hold on tight, now I expect a lot of us:
We all
 test our code use coverage strive for 100% test coverage  So, what&rsquo;s missing?
I miss some context 100% test coverage is great, but sometimes we need more information.
e.g. which test covers line XXX?
In sufficiently complex code bases, with mixed unit and integration tests, this is no longer easy to find out.
Sure, you can set a breakpoint and run your tests and wait until the breakpoint has been hit."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Blogs","item":"https://jugmac00.github.io/blog/"},{"@type":"ListItem","position":3,"name":"Enrich Test Coverage With Contexts","item":"https://jugmac00.github.io/blog/enrich-test-coverage-with-contexts/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Enrich Test Coverage With Contexts","name":"Enrich Test Coverage With Contexts","description":"Hold on tight, now I expect a lot of us:\nWe all\n test our code use coverage strive for 100% test coverage  So, what\u0026rsquo;s missing?\nI miss some context 100% test coverage is great, but sometimes we need more information.\ne.g. which test covers line XXX?\nIn sufficiently complex code bases, with mixed unit and integration tests, this is no longer easy to find out.\nSure, you can set a breakpoint and run your tests and wait until the breakpoint has been hit.","keywords":[],"articleBody":"Hold on tight, now I expect a lot of us:\nWe all\n test our code use coverage strive for 100% test coverage  So, what’s missing?\nI miss some context 100% test coverage is great, but sometimes we need more information.\ne.g. which test covers line XXX?\nIn sufficiently complex code bases, with mixed unit and integration tests, this is no longer easy to find out.\nSure, you can set a breakpoint and run your tests and wait until the breakpoint has been hit.\nWhy? Before we try to find a better way, let’s pause for a second, and think about, why would we even want to know which test covers a certain line?\nI have a couple of reasons.\nFirst, when working in a complex code base, especially in open source, when it is not my day job, and I want to add a test, I look for a similar test first, so it is easier for me to create a new one.\nSecond, it is good to know how many tests cover a certain line. In an ideal world, strictly using unit tests only, every line should be hit as infrequent as possible, so you can change an implementation without having to change many, many tests.\nThere must be a better way So, instead of setting a breakpoint to find the tests which cover a certain line, there is indeed a better way.\nSince version 5 of Coverage.py you can record and later show so-called contexts.\nActivate contexts for pytest-cov Mostly, I use pytest-cov, which is an integration of coverage and pytest.\nIn order to activate contexts I have to\n add a directive to record context add a directive to show context  In my configuration file, e.g. tox.ini, I add\n[coverage:html] show_contexts = true and for the test command, I add\n--cov-context=test so my testenv, again in tox.ini, looks like\n[testenv:coverage] commands =pytest --cov tests --cov flask_uploads --cov-report term-missing --cov-report html --cov-context=test --cov-fail-under=100 {posargs} If you use plain Coverage.py, the official documentation tells you what you need to do.\nThe result And what do we get from our updated test and coverage configuration?\nThis beauty…\nEvery line is annotated by how many tests it is covered. Also you can click on the little triangle to get a list of all relevant test functions.\nConclusion Today, we learned how to get more information out of the coverage report.\nDo you already use this feature? What are your reasons? Or do you have anything else to comment on this blog post?\nDrop me a line! Contact details see https://jugmac00.github.io/.\nThank you Thanks a lot, Ned Batchelder for maintaining this indispensable library in the Python test universe!\nIf you or especially your company relies on Coverage.py, please consider sponsoring Ned’s work.\nFurther reading  Coverapge.py: Measurement contexts pytest-cov: Contexts  ","wordCount":"466","inLanguage":"en","datePublished":"2021-05-20T14:22:51+02:00","dateModified":"2021-05-20T14:22:51+02:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://jugmac00.github.io/blog/enrich-test-coverage-with-contexts/"},"publisher":{"@type":"Organization","name":"Jürgen Gmach","logo":{"@type":"ImageObject","url":"https://jugmac00.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add('dark'):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove('dark'):window.matchMedia('(prefers-color-scheme: dark)').matches&&document.body.classList.add('dark')</script><noscript><style type=text/css>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:#1d1e20;--entry:#2e2e33;--primary:rgba(255, 255, 255, 0.84);--secondary:rgba(255, 255, 255, 0.56);--tertiary:rgba(255, 255, 255, 0.16);--content:rgba(255, 255, 255, 0.74);--hljs-bg:#2e2e33;--code-bg:#37383e;--border:#333}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><header class=header><nav class=nav><div class=logo><a href=https://jugmac00.github.io accesskey=h title="Jürgen Gmach (Alt + H)">Jürgen Gmach</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://jugmac00.github.io/about/ title=about><span>about</span></a></li><li><a href=https://jugmac00.github.io/blog/ title=blog><span>blog</span></a></li><li><a href=https://jugmac00.github.io/talks/ title=talks><span>talks</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>Enrich Test Coverage With Contexts</h1><div class=post-meta>May 20, 2021</div></header><div class=post-content><p>Hold on tight, now I expect a lot of us:</p><p>We all</p><ul><li>test our code</li><li>use coverage</li><li>strive for 100% test coverage</li></ul><p>So, what&rsquo;s missing?</p><h2 id=i-miss-some-context>I miss some context<a hidden class=anchor aria-hidden=true href=#i-miss-some-context>#</a></h2><p>100% test coverage is great, but sometimes we need more information.</p><p>e.g. which test covers line XXX?</p><p>In sufficiently complex code bases,
with mixed unit and integration tests,
this is no longer easy to find out.</p><p>Sure, you can set a breakpoint and run your tests
and wait until the breakpoint has been hit.</p><h2 id=why>Why?<a hidden class=anchor aria-hidden=true href=#why>#</a></h2><p>Before we try to find a better way,
let&rsquo;s pause for a second, and think about,
why would we even want to know which test covers a certain line?</p><p>I have a couple of reasons.</p><p>First, when working in a complex code base,
especially in open source,
when it is not my day job,
and I want to add a test,
I look for a similar test first,
so it is easier for me to create a new one.</p><p>Second, it is good to know how many tests cover a certain line.
In an ideal world, strictly using unit tests only,
every line should be hit as infrequent as possible,
so you can change an implementation without having to change many, many tests.</p><h2 id=there-must-be-a-better-way>There must be a better way<a hidden class=anchor aria-hidden=true href=#there-must-be-a-better-way>#</a></h2><p>So, instead of setting a breakpoint to find the tests which cover a certain line,
there is indeed a better way.</p><p>Since <a href=https://coverage.readthedocs.io/en/latest/changes.html#version-5-0-2019-12-14>version 5</a>
of <a href=https://coverage.readthedocs.io/en/v4.5.x/index.html>Coverage.py</a> you can record and later show so-called <a href=https://coverage.readthedocs.io/en/coverage-5.5/contexts.html>contexts</a>.</p><h2 id=activate-contexts-for-pytest-cov>Activate contexts for pytest-cov<a hidden class=anchor aria-hidden=true href=#activate-contexts-for-pytest-cov>#</a></h2><p>Mostly, I use <code>pytest-cov</code>, which is an integration of <code>coverage</code> and <code>pytest</code>.</p><p>In order to activate <code>contexts</code> I have to</p><ul><li>add a directive to record context</li><li>add a directive to show context</li></ul><p>In my configuration file, e.g. <code>tox.ini</code>, I add</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=color:#66d9ef>[coverage:html]</span>
<span style=color:#a6e22e>show_contexts</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>true</span>
</code></pre></div><p>and for the test command, I add</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=color:#a6e22e>--cov-context</span><span style=color:#f92672>=</span><span style=color:#e6db74>test</span>
</code></pre></div><p>so my <code>testenv</code>, again in <code>tox.ini</code>, looks like</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=color:#66d9ef>[testenv:coverage]</span>
<span style=color:#a6e22e>commands</span> <span style=color:#f92672>=</span><span style=color:#e6db74>
</span><span style=color:#e6db74>    pytest --cov tests --cov flask_uploads --cov-report term-missing --cov-report html --cov-context=test --cov-fail-under=100 {posargs}</span>
</code></pre></div><p>If you use plain <code>Coverage.py</code>,
the <a href=https://coverage.readthedocs.io/en/coverage-5.5/contexts.html>official documentation</a> tells you what you need to do.</p><h2 id=the-result>The result<a hidden class=anchor aria-hidden=true href=#the-result>#</a></h2><p>And what do we get from our updated test and coverage configuration?</p><p>This beauty&mldr;</p><p><img loading=lazy src=/images/coverage-with-contexts.png alt=xxx></p><p>Every line is annotated by how many tests it is covered.
Also you can click on the little triangle to get a list of all relevant test functions.</p><h2 id=conclusion>Conclusion<a hidden class=anchor aria-hidden=true href=#conclusion>#</a></h2><p>Today, we learned how to get more information out of the coverage report.</p><p>Do you already use this feature? What are your reasons?
Or do you have anything else to comment on this blog post?</p><p>Drop me a line! Contact details see <a href=https://jugmac00.github.io/>https://jugmac00.github.io/</a>.</p><h2 id=thank-you>Thank you<a hidden class=anchor aria-hidden=true href=#thank-you>#</a></h2><p>Thanks a lot, Ned Batchelder for maintaining this indispensable library in the Python test universe!</p><p>If you or especially your company relies on <code>Coverage.py</code>,
please consider <a href=https://github.com/nedbat/coveragepy>sponsoring Ned&rsquo;s work</a>.</p><h2 id=further-reading>Further reading<a hidden class=anchor aria-hidden=true href=#further-reading>#</a></h2><ul><li>Coverapge.py: <a href=https://coverage.readthedocs.io/en/coverage-5.5/contexts.html>Measurement contexts</a></li><li>pytest-cov: <a href=https://pytest-cov.readthedocs.io/en/latest/contexts.html>Contexts</a></li></ul></div><footer class=post-footer></footer></article></main><footer class=footer><span>&copy; 2021 <a href=https://jugmac00.github.io>Jürgen Gmach</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)"><button class=top-link id=top-link type=button accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></button></a>
<script>let menu=document.getElementById('menu');menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)},document.querySelectorAll('a[href^="#"]').forEach(a=>{a.addEventListener("click",function(b){b.preventDefault();var a=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView({behavior:"smooth"}),a==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${a}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove('dark'),localStorage.setItem("pref-theme",'light')):(document.body.classList.add('dark'),localStorage.setItem("pref-theme",'dark'))})</script></body></html>