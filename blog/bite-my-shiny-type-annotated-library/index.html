<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Bite My Shiny Type Annotated Library | Jürgen Gmach</title><meta name=keywords content><meta name=description content="How do you make type annotations available to the users of your library?
Well, you just type annotate your library, right?
No!
But let&rsquo;s step back for a moment.
Flask 2.0 goes full type annotations This morning I read David Lord&rsquo;s announcement that Flask, Jinja, Click, Werkzeug, MarkupSafe, and ItsDangerous are now fully type annotated, and new releases will be available next week.
Ok, as I typed Flask-Reuploaded almost a year ago, I certainly noticed that Flask was not typed back then, but external type information was provided via typeshed, which I remember lively, as I had to add a missing type annotation for Werkzeug."><meta name=author content><link rel=canonical href=https://jugmac00.github.io/blog/bite-my-shiny-type-annotated-library/><link crossorigin=anonymous href=/assets/css/stylesheet.min.309a3942f890eb0930959205be1f692b2f0e85115a8b0190361a25a37e54fffa.css integrity="sha256-MJo5QviQ6wkwlZIFvh9pKy8OhRFaiwGQNholo35U//o=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.min.7680afc38aa6b15ddf158a4f3780b7b1f7dde7e91d26f073e6229bb7a0793c92.js integrity="sha256-doCvw4qmsV3fFYpPN4C3sffd5+kdJvBz5iKbt6B5PJI=" onload=hljs.initHighlightingOnLoad()></script><link rel=icon href=https://jugmac00.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://jugmac00.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://jugmac00.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://jugmac00.github.io/apple-touch-icon.png><link rel=mask-icon href=https://jugmac00.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><meta name=generator content="Hugo 0.82.0"><meta property="og:title" content="Bite My Shiny Type Annotated Library"><meta property="og:description" content="How do you make type annotations available to the users of your library?
Well, you just type annotate your library, right?
No!
But let&rsquo;s step back for a moment.
Flask 2.0 goes full type annotations This morning I read David Lord&rsquo;s announcement that Flask, Jinja, Click, Werkzeug, MarkupSafe, and ItsDangerous are now fully type annotated, and new releases will be available next week.
Ok, as I typed Flask-Reuploaded almost a year ago, I certainly noticed that Flask was not typed back then, but external type information was provided via typeshed, which I remember lively, as I had to add a missing type annotation for Werkzeug."><meta property="og:type" content="article"><meta property="og:url" content="https://jugmac00.github.io/blog/bite-my-shiny-type-annotated-library/"><meta property="article:section" content="blog"><meta property="article:published_time" content="2021-05-09T15:40:11+02:00"><meta property="article:modified_time" content="2021-05-09T15:40:11+02:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Bite My Shiny Type Annotated Library"><meta name=twitter:description content="How do you make type annotations available to the users of your library?
Well, you just type annotate your library, right?
No!
But let&rsquo;s step back for a moment.
Flask 2.0 goes full type annotations This morning I read David Lord&rsquo;s announcement that Flask, Jinja, Click, Werkzeug, MarkupSafe, and ItsDangerous are now fully type annotated, and new releases will be available next week.
Ok, as I typed Flask-Reuploaded almost a year ago, I certainly noticed that Flask was not typed back then, but external type information was provided via typeshed, which I remember lively, as I had to add a missing type annotation for Werkzeug."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Blogs","item":"https://jugmac00.github.io/blog/"},{"@type":"ListItem","position":3,"name":"Bite My Shiny Type Annotated Library","item":"https://jugmac00.github.io/blog/bite-my-shiny-type-annotated-library/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Bite My Shiny Type Annotated Library","name":"Bite My Shiny Type Annotated Library","description":"How do you make type annotations available to the users of your library?\nWell, you just type annotate your library, right?\nNo!\nBut let\u0026rsquo;s step back for a moment.\nFlask 2.0 goes full type annotations This morning I read David Lord\u0026rsquo;s announcement that Flask, Jinja, Click, Werkzeug, MarkupSafe, and ItsDangerous are now fully type annotated, and new releases will be available next week.\nOk, as I typed Flask-Reuploaded almost a year ago, I certainly noticed that Flask was not typed back then, but external type information was provided via typeshed, which I remember lively, as I had to add a missing type annotation for Werkzeug.","keywords":[],"articleBody":"How do you make type annotations available to the users of your library?\nWell, you just type annotate your library, right?\nNo!\nBut let’s step back for a moment.\nFlask 2.0 goes full type annotations This morning I read David Lord’s announcement that Flask, Jinja, Click, Werkzeug, MarkupSafe, and ItsDangerous are now fully type annotated, and new releases will be available next week.\nOk, as I typed Flask-Reuploaded almost a year ago, I certainly noticed that Flask was not typed back then, but external type information was provided via typeshed, which I remember lively, as I had to add a missing type annotation for Werkzeug.\nI wonder how… I immediately wondered, how the type checkers then would know whether to use the inline type information or the type stubs from typeshed.\nAnthony Sottile responded on the Twitter thread, that PEP 561 handles this and he linked to one of his videos.\nIn short - you need to include an empty py.typed in your repository/package.\nWhat?\nSo, this basically means the applied type annotations have been in vain - for almost an entire year.\nI am not the only one bitten by that. I am in very good company.\nBy the way… py.typed has to be in your package root, not necessarily in your git root!\nMake mypy and co aware of your type annotations So, we know what to do, but how?\nThis depends on your build backend… and some more things, like whether you prefer setup.py or setup.cfg, whether you prefer to use package_data or rather include_package_data and use a MANIFEST.in…\nNobody claimed Python packaging is easy!\nMANIFEST.in After adding py.typed to my repository, the indispensible check-manifest told me what to do:\n❯ check-manifest lists of files in version control and sdist do not match! missing from sdist: py.typed suggested MANIFEST.in rules: include *.typed or simply add e.g. …\ninclude src/your_package/py.typed P.S.: Do not forget to add the include_package_data=True directive to your setup.py, otherwise py.typed will be included in the sdist, but not in the wheel.\nSounds logical? Right… :-/\nsetup.py If you do not use a MANIFEST.in, but setuptools with a setup.py…\nsetup( package_data={\"your_package\": [\"py.typed\"]}, ) While we are at it… take care that py.typed is not matched by exclude_package_data.\nGot it? Almost :-)\nYou also need to make sure you have the zip_safe=False directive set.\nsetup.cfg If you prefer a setup.cfg over a setup.py…\n[options.package_data] your_package = py.typed poetry If you are into poetry, there is great news.\nPoetry actually includes everything that’s part of the package source tree in your distribution, so py.typed is included out-of-the-box, no configuration needed.\nflit The same is true for flit! Just create py.typed and add it to your git repository.\nConclusion I want to end this journey into the depths of Python packaging with the famous words of a colleague on mine:\n“Kaum macht man’s richtig, schon geht’s.”\n(Translation: When you start doing it the right way, it will eventually work out.)\nUpdates 2020.05.12\n David Lukeš reported a problem with the poetry section. Previously, it included an even wrong configuration snippet. Good news! Poetry automatically packages the files in the source tree of the package. Thanks so much for your feedback! After David reported how poetry packages files, I really wanted to know how flit is doing this. So I created a package with flit and updated the blog post with my findings.  ","wordCount":"563","inLanguage":"en","datePublished":"2021-05-09T15:40:11+02:00","dateModified":"2021-05-09T15:40:11+02:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://jugmac00.github.io/blog/bite-my-shiny-type-annotated-library/"},"publisher":{"@type":"Organization","name":"Jürgen Gmach","logo":{"@type":"ImageObject","url":"https://jugmac00.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add('dark'):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove('dark'):window.matchMedia('(prefers-color-scheme: dark)').matches&&document.body.classList.add('dark')</script><noscript><style type=text/css>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:#1d1e20;--entry:#2e2e33;--primary:rgba(255, 255, 255, 0.84);--secondary:rgba(255, 255, 255, 0.56);--tertiary:rgba(255, 255, 255, 0.16);--content:rgba(255, 255, 255, 0.74);--hljs-bg:#2e2e33;--code-bg:#37383e;--border:#333}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><header class=header><nav class=nav><div class=logo><a href=https://jugmac00.github.io accesskey=h title="Jürgen Gmach (Alt + H)">Jürgen Gmach</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://jugmac00.github.io/about/ title=about><span>about</span></a></li><li><a href=https://jugmac00.github.io/blog/ title=blog><span>blog</span></a></li><li><a href=https://jugmac00.github.io/talks/ title=talks><span>talks</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>Bite My Shiny Type Annotated Library</h1><div class=post-meta>May 9, 2021</div></header><div class=post-content><p>How do you make type annotations available to the users of your library?</p><p>Well, you just type annotate your library, right?</p><p>No!</p><p>But let&rsquo;s step back for a moment.</p><h2 id=flask-20-goes-full-type-annotations>Flask 2.0 goes full type annotations<a hidden class=anchor aria-hidden=true href=#flask-20-goes-full-type-annotations>#</a></h2><p>This morning I read David Lord&rsquo;s <a href=https://twitter.com/davidism/status/1391130343286001664>announcement</a> that Flask, Jinja, Click, Werkzeug, MarkupSafe,
and ItsDangerous are now fully type annotated,
and new releases will be available next week.</p><p>Ok, as I typed <a href=https://github.com/jugmac00/flask-reuploaded>Flask-Reuploaded</a> almost a year ago,
I certainly noticed that Flask was not typed back then,
but external type information was provided via <a href=https://github.com/python/typeshed>typeshed</a>,
which I remember lively, as I had to add a missing type annotation for <a href=https://github.com/python/typeshed/pull/4308>Werkzeug</a>.</p><h2 id=i-wonder-how>I wonder how&mldr;<a hidden class=anchor aria-hidden=true href=#i-wonder-how>#</a></h2><p>I immediately wondered,
how the type checkers then would know whether to use the inline type information or the type stubs from <strong>typeshed</strong>.</p><p>Anthony Sottile responded on the Twitter thread,
that <a href=https://www.python.org/dev/peps/pep-0561/>PEP 561</a> handles this and he linked to one of his <a href="https://www.youtube.com/watch?v=n4GJ8rp6DpE">videos</a>.</p><p>In short - you need to include an empty <code>py.typed</code> in your repository/package.</p><p>What?</p><p>So, this basically means the applied type annotations have been in vain - for almost an entire year.</p><p>I am not the only one bitten by that.
I am in <a href=https://github.com/encode/httpx/issues/193>very good company</a>.</p><p>By the way&mldr; <code>py.typed</code> has to be in your package root, not necessarily in your git root!</p><h2 id=make-mypy-and-co-aware-of-your-type-annotations>Make mypy and co aware of your type annotations<a hidden class=anchor aria-hidden=true href=#make-mypy-and-co-aware-of-your-type-annotations>#</a></h2><p>So, we know what to do, but how?</p><p>This depends on your build backend&mldr; and some more things,
like whether you prefer <code>setup.py</code> or <code>setup.cfg</code>,
whether you prefer to use <code>package_data</code> or rather <code>include_package_data</code> and use a <code>MANIFEST.in</code>&mldr;</p><p>Nobody claimed Python packaging is easy!</p><h3 id=manifestin>MANIFEST.in<a hidden class=anchor aria-hidden=true href=#manifestin>#</a></h3><p>After adding <code>py.typed</code> to my repository,
the indispensible <a href=https://pypi.org/project/check-manifest/>check-manifest</a> told me what to do:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>❯ check-manifest 
lists of files in version control and sdist <span style=color:#66d9ef>do</span> not match!
missing from sdist:
  py.typed
suggested MANIFEST.in rules:
  include *.typed
</code></pre></div><p>or simply add e.g. &mldr;</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=color:#a6e22e>include src/your_package/py.typed</span>
</code></pre></div><p>P.S.: Do not forget to add the <code>include_package_data=True</code> directive to your <code>setup.py</code>,
otherwise <code>py.typed</code> will be included in the sdist, but not in the wheel.</p><p>Sounds logical? Right&mldr; :-/</p><h3 id=setuppy>setup.py<a hidden class=anchor aria-hidden=true href=#setuppy>#</a></h3><p>If you do not use a <code>MANIFEST.in</code>, but <code>setuptools</code> with a <code>setup.py</code>&mldr;</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python>setup(
    package_data<span style=color:#f92672>=</span>{<span style=color:#e6db74>&#34;your_package&#34;</span>: [<span style=color:#e6db74>&#34;py.typed&#34;</span>]},
)
</code></pre></div><p>While we are at it&mldr; take care that <code>py.typed</code> is not matched by <code>exclude_package_data</code>.</p><p>Got it? Almost :-)</p><p>You also need to make sure you have the <code>zip_safe=False</code> directive set.</p><h3 id=setupcfg>setup.cfg<a hidden class=anchor aria-hidden=true href=#setupcfg>#</a></h3><p>If you prefer a <code>setup.cfg</code> over a <code>setup.py</code>&mldr;</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=color:#66d9ef>[options.package_data]</span>
<span style=color:#a6e22e>your_package</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>py.typed</span>
</code></pre></div><h3 id=poetry>poetry<a hidden class=anchor aria-hidden=true href=#poetry>#</a></h3><p>If you are into <code>poetry</code>, there is great news.</p><p>Poetry actually includes everything that’s part of the package source tree in your distribution,
so py.typed is included out-of-the-box, no configuration needed.</p><h3 id=flit>flit<a hidden class=anchor aria-hidden=true href=#flit>#</a></h3><p>The same is true for <code>flit</code>!
Just create <code>py.typed</code> and add it to your git repository.</p><h2 id=conclusion>Conclusion<a hidden class=anchor aria-hidden=true href=#conclusion>#</a></h2><p>I want to end this journey into the depths of Python packaging with the famous words of a colleague on mine:</p><p>&ldquo;Kaum macht man&rsquo;s richtig, schon geht&rsquo;s.&rdquo;</p><p>(Translation: When you start doing it the right way, it will eventually work out.)</p><h2 id=updates>Updates<a hidden class=anchor aria-hidden=true href=#updates>#</a></h2><p><strong>2020.05.12</strong></p><ul><li><a href=https://dlukes.github.io/>David Lukeš</a> reported a problem with the <code>poetry</code> section.
Previously, it included an even wrong configuration snippet.
Good news!
Poetry automatically packages the files in the source tree of the package.
Thanks so much for your feedback!</li><li>After David reported how <code>poetry</code> packages files,
I really wanted to know how <code>flit</code> is doing this.
So I created a package with <code>flit</code> and updated the blog post with my findings.</li></ul></div><footer class=post-footer></footer></article></main><footer class=footer><span>&copy; 2021 <a href=https://jugmac00.github.io>Jürgen Gmach</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)"><button class=top-link id=top-link type=button accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></button></a>
<script>let menu=document.getElementById('menu');menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)},document.querySelectorAll('a[href^="#"]').forEach(a=>{a.addEventListener("click",function(b){b.preventDefault();var a=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView({behavior:"smooth"}),a==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${a}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove('dark'),localStorage.setItem("pref-theme",'light')):(document.body.classList.add('dark'),localStorage.setItem("pref-theme",'dark'))})</script></body></html>