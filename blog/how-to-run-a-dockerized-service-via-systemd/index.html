<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>How to Run a Dockerized Service via systemd | Jürgen Gmach</title><meta name=keywords content><meta name=description content="Until recently, I saw no good reason to use Docker, as my deployment tool of choice produces approximately identical builds, locally on my Ubuntu laptop, on staging and on production.
But time does not stand still and especially as I have to deploy a Java application, it was time to rethink my strategy, as I do not want to play the which Java runtime environment plays nicely together with which app version game."><meta name=author content><link rel=canonical href=https://jugmac00.github.io/blog/how-to-run-a-dockerized-service-via-systemd/><link crossorigin=anonymous href=/assets/css/stylesheet.min.309a3942f890eb0930959205be1f692b2f0e85115a8b0190361a25a37e54fffa.css integrity="sha256-MJo5QviQ6wkwlZIFvh9pKy8OhRFaiwGQNholo35U//o=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.min.7680afc38aa6b15ddf158a4f3780b7b1f7dde7e91d26f073e6229bb7a0793c92.js integrity="sha256-doCvw4qmsV3fFYpPN4C3sffd5+kdJvBz5iKbt6B5PJI=" onload=hljs.initHighlightingOnLoad()></script><link rel=icon href=https://jugmac00.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://jugmac00.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://jugmac00.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://jugmac00.github.io/apple-touch-icon.png><link rel=mask-icon href=https://jugmac00.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><meta name=generator content="Hugo 0.82.0"><meta property="og:title" content="How to Run a Dockerized Service via systemd"><meta property="og:description" content="Until recently, I saw no good reason to use Docker, as my deployment tool of choice produces approximately identical builds, locally on my Ubuntu laptop, on staging and on production.
But time does not stand still and especially as I have to deploy a Java application, it was time to rethink my strategy, as I do not want to play the which Java runtime environment plays nicely together with which app version game."><meta property="og:type" content="article"><meta property="og:url" content="https://jugmac00.github.io/blog/how-to-run-a-dockerized-service-via-systemd/"><meta property="article:section" content="blog"><meta property="article:published_time" content="2020-10-29T15:18:40+02:00"><meta property="article:modified_time" content="2020-10-29T15:18:40+02:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="How to Run a Dockerized Service via systemd"><meta name=twitter:description content="Until recently, I saw no good reason to use Docker, as my deployment tool of choice produces approximately identical builds, locally on my Ubuntu laptop, on staging and on production.
But time does not stand still and especially as I have to deploy a Java application, it was time to rethink my strategy, as I do not want to play the which Java runtime environment plays nicely together with which app version game."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Blogs","item":"https://jugmac00.github.io/blog/"},{"@type":"ListItem","position":3,"name":"How to Run a Dockerized Service via systemd","item":"https://jugmac00.github.io/blog/how-to-run-a-dockerized-service-via-systemd/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"How to Run a Dockerized Service via systemd","name":"How to Run a Dockerized Service via systemd","description":"Until recently, I saw no good reason to use Docker, as my deployment tool of choice produces approximately identical builds, locally on my Ubuntu laptop, on staging and on production.\nBut time does not stand still and especially as I have to deploy a Java application, it was time to rethink my strategy, as I do not want to play the which Java runtime environment plays nicely together with which app version game.","keywords":[],"articleBody":"Until recently, I saw no good reason to use Docker, as my deployment tool of choice produces approximately identical builds, locally on my Ubuntu laptop, on staging and on production.\nBut time does not stand still and especially as I have to deploy a Java application, it was time to rethink my strategy, as I do not want to play the which Java runtime environment plays nicely together with which app version game.\nFortunately, JetBrains offers pre-built docker images for YouTrack, my favorite issue tracker, which is the app I plan to install today.\nsimple is not always better With a pre-built Docker image, running the app could be as simple as …\ndocker run -it --name youtrack-server-instance \\  -v {path to data directory}:/opt/youtrack/data \\  -v {path to conf directory}:/opt/youtrack/conf \\  -v {path to logs directory}:/opt/youtrack/logs \\  -v {path to backups directory}:/opt/youtrack/backups \\  -p {port on host}:8080 \\  jetbrains/youtrack:{version} … but it is tedious to type this long command, and also the process would not survive a reboot of the host system.\nnote  Do you know the difference between docker create, docker run and docker start?\n While we are here, let’s dissect this complex command:\n run creates and starts a container -it provides an interactive tty, ie show output in the terminal --name gives the container a name -v maps folders between the host and the container -p maps ports between the host and the container jetbrains/youtrack:{version} is finally the docker image  run docker container as a systemd service Instead of manually starting the docker service, let’s use systemd to start it, even after a reboot.\nJetBrains offers a concise documentation on how to do this.\nunit file Basically, just create a unit file at /etc/systemd/system/docker.youtrack.service, with the following content…\n[Unit] Description=YouTrack Service After=docker.service Requires=docker.service [Service] TimeoutStartSec=0 Restart=always ExecStartPre=-/usr/bin/docker exec %n stop ExecStartPre=-/usr/bin/docker rm %n ExecStartPre=/usr/bin/docker pull jetbrains/youtrack: ExecStart=/usr/bin/docker run --rm --name %n \\ -v :/opt/youtrack/data \\ -v :/opt/youtrack/conf \\ -v :/opt/youtrack/logs \\ -v :/opt/youtrack/backups \\ -p :8080 \\ jetbrains/youtrack: [Install] WantedBy=default.target … where, on a very high level,\n the unit section gives this service a name, and defines the prerequisites and dependencies, the service section configures the command to be executed, and the install section defines when this service should be started.  Finally, you can enable it via systemctl enable docker.youtrack, so it starts after the next reboot, and start and stop it manually via sudo service docker.youtrack start / sudo service docker.youtrack stop.\nsome failures This all worked out perfectly, and YouTrack was available via my browser, except I was worried a bit about the output of systemctl status docker.youtrack…\nWhy are there two failures?\nFrom all I knew about Docker, the run command should create and start a container, so the container should be persistent, even after a restart.\nWhich would finally mean, systemd should successfully stop and delete the docker container e.g. on restart.\ndissect the service section of the unit file Let’s have another look at the Service section from above, especially at the following two lines.\nExecStartPre=-/usr/bin/docker exec %n stop ExecStartPre=-/usr/bin/docker rm %n  ExecStartPre is pretty self explaining, and means “execute this command before starting the service” the dash, -, just before the command, means it is ok when the following command fails = do not stop on failure! %n expands to the service, ie docker.youtrack.service  So, this means, failures are expected!\nLet’s have a look at the run command…\nExecStart=/usr/bin/docker run --rm --name %n\n ExecStart is the main process docker run, as we now know, creates and starts a container --rm - here we go, this makes sure the container is deleted on exit! --name sets the name of the container %n is the placeholder for the service  conclusion Everything is working as expected!\nThe stop and the delete commands are only safe guards, just in case another container with the same name exists, or is even running.\nRunning pre-built Docker images is a breeze.\nBut you certainly should know the basics :-)\n","wordCount":"674","inLanguage":"en","datePublished":"2020-10-29T15:18:40+02:00","dateModified":"2020-10-29T15:18:40+02:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://jugmac00.github.io/blog/how-to-run-a-dockerized-service-via-systemd/"},"publisher":{"@type":"Organization","name":"Jürgen Gmach","logo":{"@type":"ImageObject","url":"https://jugmac00.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add('dark'):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove('dark'):window.matchMedia('(prefers-color-scheme: dark)').matches&&document.body.classList.add('dark')</script><noscript><style type=text/css>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:#1d1e20;--entry:#2e2e33;--primary:rgba(255, 255, 255, 0.84);--secondary:rgba(255, 255, 255, 0.56);--tertiary:rgba(255, 255, 255, 0.16);--content:rgba(255, 255, 255, 0.74);--hljs-bg:#2e2e33;--code-bg:#37383e;--border:#333}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><header class=header><nav class=nav><div class=logo><a href=https://jugmac00.github.io accesskey=h title="Jürgen Gmach (Alt + H)">Jürgen Gmach</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://jugmac00.github.io/about/ title=about><span>about</span></a></li><li><a href=https://jugmac00.github.io/blog/ title=blog><span>blog</span></a></li><li><a href=https://jugmac00.github.io/talks/ title=talks><span>talks</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>How to Run a Dockerized Service via systemd</h1><div class=post-meta>October 29, 2020</div></header><div class=post-content><p>Until recently, I saw no good reason to use <strong>Docker</strong>,
as my <a href=https://batou.readthedocs.io/en/stable/>deployment tool</a> of <em>choice</em> produces approximately identical builds,
locally on my Ubuntu laptop, on staging and on production.</p><p>But time does not stand still and especially as I have to deploy a Java application,
it was time to rethink my strategy,
as I do not want to play the <strong>which Java runtime environment plays nicely together with which app version</strong> game.</p><p>Fortunately, <a href=https://www.jetbrains.com/>JetBrains</a>
offers <a href=https://hub.docker.com/r/jetbrains/youtrack/>pre-built docker images</a>
for <a href=https://www.jetbrains.com/youtrack/>YouTrack</a>,
my favorite issue tracker,
which is the app I plan to install today.</p><h2 id=simple-is-not-always-better>simple is not always better<a hidden class=anchor aria-hidden=true href=#simple-is-not-always-better>#</a></h2><p>With a pre-built <strong>Docker</strong> image,
<a href=https://www.jetbrains.com/help/youtrack/standalone/youtrack-docker-installation.html#run-youtrack-service>running the app</a> could be as simple as &mldr;</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>docker run -it --name youtrack-server-instance  <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>    -v <span style=color:#f92672>{</span>path to data directory<span style=color:#f92672>}</span>:/opt/youtrack/data <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>    -v <span style=color:#f92672>{</span>path to conf directory<span style=color:#f92672>}</span>:/opt/youtrack/conf  <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>    -v <span style=color:#f92672>{</span>path to logs directory<span style=color:#f92672>}</span>:/opt/youtrack/logs  <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>    -v <span style=color:#f92672>{</span>path to backups directory<span style=color:#f92672>}</span>:/opt/youtrack/backups  <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>    -p <span style=color:#f92672>{</span>port on host<span style=color:#f92672>}</span>:8080 <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>    jetbrains/youtrack:<span style=color:#f92672>{</span>version<span style=color:#f92672>}</span>
</code></pre></div><p>&mldr; but it is tedious to type this long command,
and also the process would not survive a reboot of the host system.</p><h2 id=note>note<a hidden class=anchor aria-hidden=true href=#note>#</a></h2><blockquote><p>Do you know the <a href=https://github.com/jugmac00/til/blob/master/docker/difference-between-docker-create-start-run.md>difference</a>
between <code>docker create</code>, <code>docker run</code> and <code>docker start</code>?</p></blockquote><p>While we are here, let&rsquo;s dissect this complex command:</p><ul><li><code>run</code> creates and starts a container</li><li><code>-it</code> provides an interactive tty, ie show output in the terminal</li><li><code>--name</code> gives the container a name</li><li><code>-v</code> maps folders between the host and the container</li><li><code>-p</code> maps ports between the host and the container</li><li><code>jetbrains/youtrack:{version}</code> is finally the docker image</li></ul><h2 id=run-docker-container-as-a-systemd-service>run docker container as a systemd service<a hidden class=anchor aria-hidden=true href=#run-docker-container-as-a-systemd-service>#</a></h2><p>Instead of manually starting the docker service,
let&rsquo;s use <strong>systemd</strong> to start it, even after a reboot.</p><p>JetBrains offers a <a href=https://www.jetbrains.com/help/youtrack/standalone/run-docker-container-as-service.html>concise documentation</a> on how to do this.</p><h2 id=unit-file>unit file<a hidden class=anchor aria-hidden=true href=#unit-file>#</a></h2><p>Basically, just create a unit file at <code>/etc/systemd/system/docker.youtrack.service</code>,
with the following content&mldr;</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-systemd data-lang=systemd><span style=color:#66d9ef>[Unit]</span>
<span style=color:#a6e22e>Description</span><span style=color:#f92672>=</span><span style=color:#e6db74>YouTrack Service</span>
<span style=color:#a6e22e>After</span><span style=color:#f92672>=</span><span style=color:#e6db74>docker.service</span>
<span style=color:#a6e22e>Requires</span><span style=color:#f92672>=</span><span style=color:#e6db74>docker.service</span>

<span style=color:#66d9ef>[Service]</span>
<span style=color:#a6e22e>TimeoutStartSec</span><span style=color:#f92672>=</span><span style=color:#e6db74>0</span>
<span style=color:#a6e22e>Restart</span><span style=color:#f92672>=</span><span style=color:#e6db74>always</span>
<span style=color:#a6e22e>ExecStartPre</span><span style=color:#f92672>=</span><span style=color:#e6db74>-/usr/bin/docker exec %n stop</span>
<span style=color:#a6e22e>ExecStartPre</span><span style=color:#f92672>=</span><span style=color:#e6db74>-/usr/bin/docker rm %n</span>
<span style=color:#a6e22e>ExecStartPre</span><span style=color:#f92672>=</span><span style=color:#e6db74>/usr/bin/docker pull jetbrains/youtrack:&lt;version&gt;</span>
<span style=color:#a6e22e>ExecStart</span><span style=color:#f92672>=</span><span style=color:#e6db74>/usr/bin/docker run --rm --name %n </span>\
<span style=color:#e6db74>    -v &lt;path to data directory&gt;:/opt/youtrack/data </span>\
<span style=color:#e6db74>    -v &lt;path to conf directory&gt;:/opt/youtrack/conf </span>\
<span style=color:#e6db74>    -v &lt;path to logs directory&gt;:/opt/youtrack/logs </span>\
<span style=color:#e6db74>    -v &lt;path to backups directory&gt;:/opt/youtrack/backups </span>\
<span style=color:#e6db74>    -p &lt;port on host&gt;:8080 </span>\
<span style=color:#e6db74>    jetbrains/youtrack:&lt;version&gt;</span>

<span style=color:#66d9ef>[Install]</span>
<span style=color:#a6e22e>WantedBy</span><span style=color:#f92672>=</span><span style=color:#e6db74>default.target</span>
</code></pre></div><p>&mldr; where, on a very high level,</p><ul><li>the unit section gives this service a name, and defines the prerequisites and dependencies,</li><li>the service section configures the command to be executed,</li><li>and the install section defines when this service should be started.</li></ul><p>Finally, you can enable it via <code>systemctl enable docker.youtrack</code>,
so it starts after the next reboot,
and start and stop it manually via <code>sudo service docker.youtrack start</code> / <code>sudo service docker.youtrack stop</code>.</p><h2 id=some-failures>some failures<a hidden class=anchor aria-hidden=true href=#some-failures>#</a></h2><p>This all worked out perfectly,
and <code>YouTrack</code> was available via my browser,
except I was worried a bit about the output of <code>systemctl status docker.youtrack</code>&mldr;</p><p><img loading=lazy src=/images/docker-systemd.png alt="systemd status"></p><p>Why are there two failures?</p><p>From all I knew about <strong>Docker</strong>,
the run command should create and start a container,
so the container should be persistent,
even after a restart.</p><p>Which would finally mean,
<strong>systemd</strong> should successfully stop and delete the docker container e.g. on restart.</p><h3 id=dissect-the-service-section-of-the-unit-file>dissect the service section of the unit file<a hidden class=anchor aria-hidden=true href=#dissect-the-service-section-of-the-unit-file>#</a></h3><p>Let&rsquo;s have another look at the <em>Service</em> section from above, especially at the following two lines.</p><pre><code>ExecStartPre=-/usr/bin/docker exec %n stop
ExecStartPre=-/usr/bin/docker rm %n
</code></pre><ul><li><code>ExecStartPre</code> is pretty self explaining, and means &ldquo;execute this command before starting the service&rdquo;</li><li>the dash, <code>-</code>, just before the command, means it is ok when the following command fails = do not stop on failure!</li><li><code>%n</code> expands to the service, ie <code>docker.youtrack.service</code></li></ul><p>So, this means, <strong>failures</strong> are expected!</p><p>Let&rsquo;s have a look at the <code>run</code> command&mldr;</p><p><code>ExecStart=/usr/bin/docker run --rm --name %n</code></p><ul><li><code>ExecStart</code> is the main process</li><li><code>docker run</code>, as we now know, creates and starts a container</li><li><code>--rm</code> - here we go, this makes sure the container is deleted on exit!</li><li><code>--name</code> sets the name of the container</li><li><code>%n</code> is the placeholder for the service</li></ul><h2 id=conclusion>conclusion<a hidden class=anchor aria-hidden=true href=#conclusion>#</a></h2><p>Everything is working as expected!</p><p>The <code>stop</code> and the <code>delete</code> commands are only safe guards,
just in case another container with the same name exists,
or is even running.</p><p>Running pre-built <strong>Docker</strong> images is a breeze.</p><p>But you certainly should know the basics :-)</p></div><footer class=post-footer></footer></article></main><footer class=footer><span>&copy; 2021 <a href=https://jugmac00.github.io>Jürgen Gmach</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)"><button class=top-link id=top-link type=button accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></button></a>
<script>let menu=document.getElementById('menu');menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)},document.querySelectorAll('a[href^="#"]').forEach(a=>{a.addEventListener("click",function(b){b.preventDefault();var a=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView({behavior:"smooth"}),a==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${a}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove('dark'),localStorage.setItem("pref-theme",'light')):(document.body.classList.add('dark'),localStorage.setItem("pref-theme",'dark'))})</script></body></html>